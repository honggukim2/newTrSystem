<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.trsystem.mybatis.mapper.sysMngMapper">

    <select id="TrsCodeList" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            CD_VALUE,
            CD_NM,
            USE_YN,
            COUNT(*) OVER () AS TOTAL_ITEMS
        FROM CD
        WHERE 1=1
            AND UP_CD_VALUE IS NULL
        <if test="cdVal != null and cdVal !=''">
            AND CD_VALUE LIKE CONCAT('%', #{cdVal}, '%')
        </if>
		<if test="cdValue != null and cdValue !=''">
            AND CD_VALUE LIKE CONCAT('%', #{cdValue}, '%')
        </if>
        <if test="cdNm != null and cdNm !=''">
            AND CD_NM LIKE CONCAT('%', #{cdNm}, '%')
        </if>
    </select>

    <select id="authCdList" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT
			E.EMP_ID,
			E.EMPNO,
			(SELECT CD_NM FROM CD WHERE CD_VALUE = E.JBPS_CD) AS JBPS_NM,
			E.EMP_FLNM,
			E.JBPS_CD,
			GROUP_CONCAT(DISTINCT D.DEPT_NM) AS DEPT_ID,
			IFNULL(MAX(CASE WHEN U.AUTHRT_CD = 'VTW04801' THEN 'Y' END), 'N') AS VTW04801,
			IFNULL(MAX(CASE WHEN U.AUTHRT_CD = 'VTW04802' THEN 'Y' END), 'N') AS VTW04802,
			IFNULL(MAX(CASE WHEN U.AUTHRT_CD = 'VTW04803' THEN 'Y' END), 'N') AS VTW04803,
			IFNULL(MAX(CASE WHEN U.AUTHRT_CD = 'VTW04804' THEN 'Y' END), 'N') AS VTW04804,
			IFNULL(MAX(CASE WHEN U.AUTHRT_CD = 'VTW04805' THEN 'Y' END), 'N') AS VTW04805,
			IFNULL(MAX(CASE WHEN U.AUTHRT_CD = 'VTW04806' THEN 'Y' END), 'N') AS VTW04806,
			IFNULL(MAX(CASE WHEN U.AUTHRT_CD = 'VTW04807' THEN 'Y' END), 'N') AS VTW04807,
			COUNT(*) OVER () AS TOTAL_ITEMS
		FROM EMP E
			LEFT JOIN USER_AUTHRT U ON E.EMP_ID = U.EMP_ID
			LEFT OUTER JOIN DEPT_HNF DF ON E.EMP_ID = DF.EMP_ID
			LEFT OUTER JOIN DEPT D ON D.DEPT_ID = DF.DEPT_ID
		WHERE 1=1
		AND EMP_TY_CD NOT LIKE 'VTW00203%'
		AND E.HDOF_STTS_CD != 'VTW00302'
		AND E.JBPS_CD != 'VTW00119'
		<if test="hdofSttsNm != null and !hdofSttsNm.equals('')">
			AND E.HDOF_STTS_CD LIKE CONCAT('%', #{hdofSttsNm}, '%')
		</if>
		<if test="jbpsNm != null and !jbpsNm.equals('')">
			AND E.JBPS_CD LIKE CONCAT('%', #{jbpsNm}, '%')
		</if>
		<if test="deptId != null and deptId !=''">
			AND D.DEPT_ID LIKE CONCAT('%', #{deptId}, '%')
		</if>
		<if test="empno != null and empno !=''">
			AND E.EMPNO LIKE CONCAT('%', #{empno}, '%')
		</if>
		<if test="empFlnm != null and empFlnm !=''">
			AND E.EMP_FLNM LIKE CONCAT('%', #{empFlnm}, '%')
		</if>
		<if test="telNo != null and telNo !=''">
			AND E.TELNO LIKE CONCAT('%', #{telNo}, '%')
		</if>
		GROUP BY E.EMP_ID, E.EMPNO, E.JBPS_CD, E.EMP_FLNM, E.EMPNO
		ORDER BY E.EMPNO
    </select>

    <select id="customersList" parameterType="map" resultType="com.trsystem.LowerHashMap">
        select
            COUNT(*) OVER () AS TOTAL_ITEMS,
            CTMMNY_ID,
            CTMMNY_NM ,
            CTMMNY_ENG_NM,
            INDUST_CD,
            USE_YN
        FROM nwTr.CTMMNY_INFO
        WHERE 1=1
            <if test="ctmmnyNm != null and !ctmmnyNm.equals('')">
                AND CTMMNY_NM LIKE CONCAT('%', #{ctmmnyNm}, '%')
            </if>
            <if test="industCd != null and !industCd.equals('')">
                AND INDUST_CD = #{industCd}
            </if>
        ORDER BY REG_DT DESC
    </select>

    <select id="userInfo" parameterType="String" resultType="com.trsystem.LowerHashMap">
	SELECT LU.EMP_ID,
		   LU.EMPNO,
	       E.EMP_FLNM AS EMP_NM,
		   (SELECT CD_NM FROM CD WHERE CD_VALUE = E.JBPS_CD) JBPS_NM,
		   E.JBPS_CD,
		   E.EMP_TY_CD,
		   PSWD,
		   INTL_PWSD_YN
	 FROM LGN_USER LU
	 JOIN EMP E
	   ON LU.EMP_ID = E.EMP_ID
	WHERE 1=1
	<if test="empno != null">
		<if test="!empno.equals('')">
			AND   E.EMPNO = #{empno}
		</if>
	</if>
	<if test="empId != null">
		<if test="!empId.equals('')">
			AND   E.EMP_ID = #{empId}
		</if>
	</if>
	AND USE_PSBLTY_ACNT_YN = 'Y'
    </select>

    <select id="userAuth" parameterType="String" resultType="com.trsystem.LowerHashMap">
    SELECT ag.AUTHRT_GROUP_ID , am.AUTHRT_CD
    FROM AUTHRT_GROUP ag
             JOIN AUTHRT_MAPNG am
             JOIN LGN_USER_AUTHRT lua
                  ON ag.AUTHRT_GROUP_ID = am.AUTHRT_GROUP_ID
                      AND lua.AUTHRT_GROUP_ID = ag.AUTHRT_GROUP_ID
    WHERE lua.EMP_ID = #{empId}
    </select>

    <select id="userDept" parameterType="String" resultType="com.trsystem.LowerHashMap">
      SELECT A.DEPT_ID
           , A.DEPT_NM
           , B.JBTTL_CD
        FROM DEPT A
        JOIN DEPT_HNF B
          ON A.DEPT_ID = B.DEPT_ID
        WHERE B.EMP_ID = #{empId}
    </select>
    
    <!-- main용 쿼리들-->
    <!-- main 공지사항 쿼리-->
    <select id="retrieveNotice" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT
			ROW_NUMBER() OVER() ROWNUM
			, NOTICE_ID
			, NOTICE_TTL
			, SGNAL_ORDR
			, e.EMP_FLNM AS REG_EMP_ID
			, DATE_FORMAT(n.REG_DT, '%Y-%m-%d %H:%i') AS REG_DT
			, COUNT(*) OVER () AS TOTAL_ITEMS
		FROM NOTICE n
		LEFT JOIN EMP e ON n.REG_EMP_ID = e.EMP_ID
		WHERE 1=1
			AND SGNAL_ORDR IN (0, 1)
		ORDER BY
		CASE
		WHEN SGNAL_ORDR IN (1, 3) THEN 0
		ELSE 1
		END,
		REG_DT DESC
		limit 11
	</select>
	
	<!-- main 현차수 TR 입력사항-->
	<select id="retrieveInptSttus" parameterType="map" resultType="com.trsystem.LowerHashMap">
		select
		E.EMP_ID
		,CONCAT((select COUNT(*)*8 FROM CRTR_DATE WHERE CRTR_YMD LIKE CONCAT(#{aplyYm},'%') AND CRTR_ODR = #{aplyOdr} AND HLDY_CL_CD ="VTW05001"),"시간") AS TOTAL
		,CONCAT(IFNULL(AA.SUM,0),"시간")AS SUM		
		,CONCAT((CASE WHEN AA.STTS_CD = 'VTW03704' THEN AA.SUM  ELSE 0 END),"시간") AS MM_REJECT			
		,CONCAT((CASE WHEN AA.STTS_CD = 'VTW03703' THEN AA.SUM  ELSE 0 END),"시간") AS MM_COMPLETE
		,CONCAT(IFNULL(BB.CNT,0),"건")AS CNT		
		,CONCAT((CASE WHEN BB.STTS_CD = 'VTW03704' THEN BB.CNT  ELSE 0 END),"건") AS APLY_REJECT			
		,CONCAT((CASE WHEN BB.STTS_CD = 'VTW03703' THEN BB.CNT  ELSE 0 END),"건") AS APLY_COMPLETE  	
		from EMP E
		LEFT OUTER JOIN(
				select 
		 			(count(*)*8)as SUM
		 			,pma.EMP_ID 
		 			,pmaz.ATRZ_DMND_STTS_CD STTS_CD
		 		from 
		 			PRJCT_MM_APLY pma 
		 		JOIN 
		 			PRJCT_MM_ATRZ pmaz
			 		ON pma.PRJCT_ID =pmaz.PRJCT_ID 
				 		AND pma.EMP_ID =pmaz.EMP_ID 
				 		AND pma.APLY_YM =pmaz.APLY_YM 
				 		AND pma.APLY_ODR =pmaz.APLY_ODR 
				 		AND pma.APLY_YMD =pmaz.APLY_YMD 
		 		WHERE
		 		1=1
				  AND pma.APLY_YM = #{aplyYm}
				  AND pma.APLY_ODR =#{aplyOdr}
		 		group by 
		 			pma.EMP_ID, STTS_CD
		)AA ON AA.EMP_ID =E.EMP_ID 
		LEFT OUTER JOIN(
			   	 SELECT
			   	 Count(*) as CNT
			   	 , pca.EMP_ID
			   	 , pcaz.ATRZ_DMND_STTS_CD STTS_CD
				 FROM PRJCT_CT_APLY pca
				 JOIN PRJCT_CT_ATRZ pcaz
					 ON pca.PRJCT_CT_APLY_SN = pcaz.PRJCT_CT_APLY_SN
						  AND pca.EMP_ID = pcaz.EMP_ID
						  AND pca.APLY_YM = pcaz.APLY_YM
						  AND pca.APLY_ODR = pcaz.APLY_ODR
				WHERE
					 1=1
					  AND pca.APLY_YM = #{aplyYm}
					  AND pca.APLY_ODR = #{aplyOdr}
		 		group by 
		 			pca.EMP_ID, STTS_CD
		)BB ON BB.EMP_ID =E.EMP_ID
		where 
		1=1
		AND E.EMP_ID =#{empId}
	</select>
	
	<!-- main 결재 신청현황 -->
	<select id="retrieveAtrzAplySttus" parameterType="map" resultType="com.trsystem.LowerHashMap">
		select DISTINCT * from
			   	(SELECT  
			   	  pca.EMP_ID AS ID														-- 사번
			   	 , '프로젝트 비용' AS TY_SE													-- 결재유형
			   	 ,CONCAT(pca.APLY_YM ,'-',pca.APLY_ODR ,'차수 프로젝트 비용') AS TITLE				-- 결재명
			   	 , e.EMP_FLNM 			  AS ATRZ_EMP_NM								-- 기안자명
			   	 , DATE_FORMAT(pca.REG_DT, '%Y-%m-%d') AS REG_DT						-- 결재 올린날
			   	 , sttsCd.CD_NM	AS ATRZ_STTS_CD_NM										-- 결자생태명
			   	 , pcaz.APRVR_EMP_ID AS APRPVR_ID										-- 결재자 ID
				 FROM PRJCT_CT_APLY pca
				 JOIN PRJCT_CT_ATRZ pcaz
					 ON pca.PRJCT_CT_APLY_SN = pcaz.PRJCT_CT_APLY_SN
						  AND pca.EMP_ID = pcaz.EMP_ID
						  AND pca.APLY_YM = pcaz.APLY_YM
						  AND pca.APLY_ODR = pcaz.APLY_ODR
				 LEFT JOIN CD sttsCd ON pcaz.ATRZ_DMND_STTS_CD = sttsCd.CD_VALUE -- 결재상태명
				 LEFT JOIN EMP e on e.EMP_ID =pca.EMP_ID
				 WHERE 
				 1=1
				 AND pca.EMP_ID = #{empId}
		 		group by 
		 			pca.EMP_ID, pca.REG_DT,pca.APLY_YM,pca.APLY_ODR,pcaz.APRVR_EMP_ID,sttsCd.CD_NM	
			union all
				select 
		 			 pma.EMP_ID AS ID												-- 사번
		 			, '근무시간'	AS TY_SE											-- 결재유형
		 			,CONCAT(pma.APLY_YM ,'-',pma.APLY_ODR ,'근무시간') AS TITLE  		-- 결재명
		 			, e.EMP_FLNM AS ATRZ_EMP_NM										-- 기안자명
		 			, DATE_FORMAT(pma.REG_DT, '%Y-%m-%d') AS REG_DT					-- 기안일자
		 			, sttsCd.CD_NM AS ATRZ_STTS_CD_NM								-- 결자생태명
		 			, pmaz.APRVR_EMP_ID	AS APRPVR_ID								-- 결재자 ID
		 		from 
		 			PRJCT_MM_APLY pma 
		 		JOIN 
		 			PRJCT_MM_ATRZ pmaz
			 		ON pma.PRJCT_ID =pmaz.PRJCT_ID 
				 		AND pma.EMP_ID =pmaz.EMP_ID 
				 		AND pma.APLY_YM =pmaz.APLY_YM 
				 		AND pma.APLY_ODR =pmaz.APLY_ODR 
				 		AND pma.APLY_YMD =pmaz.APLY_YMD
				LEFT JOIN CD sttsCd ON pmaz.ATRZ_DMND_STTS_CD = sttsCd.CD_VALUE -- 결재상태명
				 LEFT JOIN EMP e on e.EMP_ID =pma.EMP_ID
		 		WHERE
		 		1=1
		 		AND pma.EMP_ID = #{empId}
		 		group by 
		 		pma.EMP_ID,pma.REG_DT,pma.APLY_YM,pma.APLY_ODR,pmaz.APRVR_EMP_ID,sttsCd.CD_NM 
		 		union ALL 
		 		SELECT DISTINCT
		 			ea.ELCTRN_ATRZ_ID AS ID							-- 전자결재 id
					, tyCd.CD_NM AS TY_SE							-- 전자결재 결재구분명
					, COALESCE(ga.GNRL_ATRZ_TTL, ca.CLM_ATRZ_TTL, cta.CTRT_ATRZ_TTL, cga.ATRZ_TTL,
					CONCAT((SELECT CD_NM FROM CD WHERE CD_VALUE = va.VCATN_TY_CD), ' [', va.VCATN_BGNG_YMD, ' ~ ', va.VCATN_END_YMD, ' (', va.VCATN_DE_CNT, '일)]')) AS TITLE
					, e1.EMP_FLNM AS ATRZ_EMP_NM				 	-- 기안자
					, DATE_FORMAT(ea.REG_DT, '%Y-%m-%d') AS REG_DT 	-- 기안일자
					, sttsCd.CD_NM AS ATRZ_STTS_CD 					-- 결재상태 (VTW008)
					, ea.ELCTRN_ATRZ_TY_SE_CD 						-- 전자결재 유형 코드
				FROM ELCTRN_ATRZ ea
				LEFT JOIN ATRZ_LN al
				ON ea.ELCTRN_ATRZ_ID = al.ELCTRN_ATRZ_ID
				AND ea.NOW_ATRZ_LN_SN = al.ATRZ_LN_SN
				LEFT JOIN CD tyCd ON ea.ELCTRN_ATRZ_TY_SE_CD = tyCd.CD_VALUE -- 전자결재 유형코드 명
				LEFT JOIN CD sttsCd ON al.ATRZ_STTS_CD = sttsCd.CD_VALUE -- 결재상태 (VTW008) 명
				LEFT JOIN GNRL_ATRZ ga ON ea.ELCTRN_ATRZ_ID = ga.ELCTRN_ATRZ_ID -- 일반결재
				LEFT JOIN CLM_ATRZ ca ON ea.ELCTRN_ATRZ_ID = ca.ELCTRN_ATRZ_ID -- 청구결재 - 거래처명
				LEFT JOIN VCATN_ATRZ va ON ea.ELCTRN_ATRZ_ID = va.ELCTRN_ATRZ_ID -- 휴가결재 제목
				LEFT JOIN CTRT_ATRZ cta ON ea.ELCTRN_ATRZ_ID = cta.ELCTRN_ATRZ_ID -- 계약 지급
				LEFT JOIN CTRT_GIVE_ATRZ cga ON ea.ELCTRN_ATRZ_ID = cga.ELCTRN_ATRZ_ID -- 계약 지급
				JOIN EMP e1 ON ea.ATRZ_DMND_EMP_ID = e1.EMP_ID
				WHERE 1=1
					AND ea.ATRZ_DMND_EMP_ID = #{empId}
					)
				AS RESULT 
				ORDER BY REG_DT ASC
				LIMIT 4
	</select>
	
	<!-- main 결재리스트-->
	<select id="retiveAtrzList" parameterType="map" resultType="com.trsystem.LowerHashMap">
	select DISTINCT * from
			  (
			   	SELECT 
				   	 pca.PRJCT_ID AS ID														-- 프로젝트ID
				   	, '프로젝트 비용' AS TY_SE													-- 결재유형
				   	,CONCAT(pca.APLY_YM ,'-',pca.APLY_ODR ,'차수 프로젝트 비용') AS TITLE			-- 결재명
				   	, e.EMP_FLNM 			  AS ATRZ_EMP_NM								-- 기안자명
				   	, DATE_FORMAT(pca.REG_DT, '%Y-%m-%d') AS REG_DT							-- 결재 올린날
				   	, sttsCd.CD_NM	AS ATRZ_STTS_CD_NM										-- 결자생태명
				   	, pcaz.APRVR_EMP_ID AS APRPVR_ID										-- 결재자 ID
				 FROM 
				 	PRJCT_CT_APLY pca
				 	JOIN PRJCT_CT_ATRZ pcaz
					ON pca.PRJCT_CT_APLY_SN = pcaz.PRJCT_CT_APLY_SN
						  AND pca.EMP_ID = pcaz.EMP_ID
						  AND pca.APLY_YM = pcaz.APLY_YM
						  AND pca.APLY_ODR = pcaz.APLY_ODR
				 LEFT JOIN CD sttsCd ON pcaz.ATRZ_DMND_STTS_CD = sttsCd.CD_VALUE -- 결재상태명
				 LEFT JOIN EMP e on e.EMP_ID =pca.EMP_ID
				 WHERE 
				 1=1
				 AND pcaz.ATRZ_DMND_STTS_CD = "VTW03702"
				 AND pcaz.APRVR_EMP_ID = #{empId}
		 		group by 
		 			pca.PRJCT_ID, pca.REG_DT,pca.APLY_YM,pca.APLY_ODR,pcaz.APRVR_EMP_ID,sttsCd.CD_NM,e.EMP_FLNM	
			UNION ALL
				select 
		 			 pma.PRJCT_ID AS ID												-- 프로젝트ID
		 			, '근무시간'	AS TY_SE											-- 결재유형
		 			,CONCAT(pma.APLY_YM ,'-',pma.APLY_ODR ,'차수 근무시간') AS TITLE  	-- 결재명
		 			, e.EMP_FLNM AS ATRZ_EMP_NM										-- 기안자명
		 			, DATE_FORMAT(pma.REG_DT, '%Y-%m-%d') AS REG_DT					-- 기안일자
		 			, sttsCd.CD_NM AS ATRZ_STTS_CD_NM								-- 결자생태명
		 			, pmaz.APRVR_EMP_ID	AS APRPVR_ID								-- 결재자 ID
		 		from 
		 			PRJCT_MM_APLY pma 
		 		JOIN 
		 			PRJCT_MM_ATRZ pmaz
			 		ON pma.PRJCT_ID =pmaz.PRJCT_ID 
				 		AND pma.EMP_ID =pmaz.EMP_ID 
				 		AND pma.APLY_YM =pmaz.APLY_YM 
				 		AND pma.APLY_ODR =pmaz.APLY_ODR 
				 		AND pma.APLY_YMD =pmaz.APLY_YMD
				LEFT JOIN CD sttsCd ON pmaz.ATRZ_DMND_STTS_CD = sttsCd.CD_VALUE -- 결재상태명
				 LEFT JOIN EMP e on e.EMP_ID =pma.EMP_ID
		 		WHERE
		 		1=1
		 		AND pmaz.ATRZ_DMND_STTS_CD = "VTW03702"
		 		AND pmaz.APRVR_EMP_ID = #{empId}
		 		group by 
		 		pma.PRJCT_ID,pma.REG_DT,pma.APLY_YM,pma.APLY_ODR,pmaz.APRVR_EMP_ID,sttsCd.CD_NM,e.EMP_FLNM	 
		 	UNION ALL 
		 		SELECT DISTINCT
		 			ea.ELCTRN_ATRZ_ID AS ID							-- 전자결재 id
					, tyCd.CD_NM AS TY_SE							-- 전자결재 결재구분명
					, COALESCE(ga.GNRL_ATRZ_TTL, ca.CLM_ATRZ_TTL, cta.CTRT_ATRZ_TTL, cga.ATRZ_TTL,
					CONCAT((SELECT CD_NM FROM CD WHERE CD_VALUE = va.VCATN_TY_CD), ' [', va.VCATN_BGNG_YMD, ' ~ ', va.VCATN_END_YMD, ' (', va.VCATN_DE_CNT, '일)]')) AS TITLE
					, e1.EMP_FLNM AS ATRZ_EMP_NM				 	-- 기안자
					, DATE_FORMAT(ea.REG_DT, '%Y-%m-%d') AS REG_DT 	-- 기안일자
					, sttsCd.CD_NM AS ATRZ_STTS_CD 					-- 결재상태 (VTW008)
					, ea.ELCTRN_ATRZ_TY_SE_CD 						-- 전자결재 유형 코드
				FROM ELCTRN_ATRZ ea
				LEFT JOIN ATRZ_LN al
				ON ea.ELCTRN_ATRZ_ID = al.ELCTRN_ATRZ_ID
				AND ea.NOW_ATRZ_LN_SN = al.ATRZ_LN_SN
				LEFT JOIN CD tyCd ON ea.ELCTRN_ATRZ_TY_SE_CD = tyCd.CD_VALUE -- 전자결재 유형코드 명
				LEFT JOIN CD sttsCd ON al.ATRZ_STTS_CD = sttsCd.CD_VALUE -- 결재상태 (VTW008) 명
				LEFT JOIN GNRL_ATRZ ga ON ea.ELCTRN_ATRZ_ID = ga.ELCTRN_ATRZ_ID -- 일반결재
				LEFT JOIN CLM_ATRZ ca ON ea.ELCTRN_ATRZ_ID = ca.ELCTRN_ATRZ_ID -- 청구결재 - 거래처명
				LEFT JOIN VCATN_ATRZ va ON ea.ELCTRN_ATRZ_ID = va.ELCTRN_ATRZ_ID -- 휴가결재 제목
				LEFT JOIN CTRT_ATRZ cta ON ea.ELCTRN_ATRZ_ID = cta.ELCTRN_ATRZ_ID -- 계약 지급
				LEFT JOIN CTRT_GIVE_ATRZ cga ON ea.ELCTRN_ATRZ_ID = cga.ELCTRN_ATRZ_ID -- 계약 지급
				JOIN EMP e1 ON ea.ATRZ_DMND_EMP_ID = e1.EMP_ID
				WHERE 1=1
					AND ea.ATRZ_DMND_STTS_CD ="VTW03702"
					AND al.APRVR_EMP_ID = #{empId}
			UNION ALL
				SELECT 
					pal.PRJCT_ID AS ID																	-- 프로젝트ID
				  , '프로젝트 승인' AS TY_SE																	-- 결재 구분	
				  , p.PRJCT_NM AS TITLE																	-- 프로젝트명
				  , e.EMP_FLNM	AS ATRZ_EMP_NM															-- 직원이름(기안자)
				  , DATE_FORMAT(pal.REG_DT, '%Y-%m-%d') AS REG_DT 										-- 계약일자
				  , (SELECT CD_NM FROM CD WHERE CD_VALUE = pald.ATRZ_STTS_CD) AS ATRZ_STTS_CD_NM		-- 결재상태코드명
				  , pald.ATRZ_STTS_CD																	-- 결재상태코드
			  FROM PRJCT_ATRZ_LN pal																	-- 프로젝트 결재선
			  JOIN PRJCT_ATRZ_LN_DTL pald ON(pal.PRJCT_ID = pald.PRJCT_ID AND pal.ATRZ_LN_SN = pald.ATRZ_LN_SN AND pal.NOW_ATRZ_STEP_CD = pald.ATRZ_STEP_CD) -- 프로젝트 결재선 상세
			  JOIN PRJCT p ON (p.PRJCT_ID = pal.PRJCT_ID AND p.PRJCT_ID = pald.PRJCT_ID)				-- 프로젝트테이블의 ID와 결재상세 테이블 ID JOIN
			  JOIN EMP e  ON (e.EMP_ID = pal.REG_EMP_ID)												-- 사원 ID와 결재테이블 등록 ID JOIN
			 WHERE 1=1
			   AND pald.APRVR_EMP_ID = #{empId} 
			   AND pald.ATRZ_STTS_CD != 'VTW00803'														-- 결재상태코드 반려 아닐시
    		   AND pald.ATRZ_STTS_CD != 'VTW00805'														-- 결재상태코드 취소 아닐시
				)
				AS RESULT 
				ORDER BY REG_DT ASC
				LIMIT 4
				
	</select>
	<!-- 전자결재(관리자메뉴) 쿼리  -->
	<select id="retrieveElecAtrzMng" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT M.ELCTRN_ATRZ_ID						-- 전자결재 ID
		     , M.PRJCT_ID							-- 프로젝트 ID
		     , M.ELCTRN_ATRZ_TY_SE_CD				-- 전자결재유형코드
		     , M.TY_CD AS ELCTRN_ATRZ_TY_SE_CD_NM
		     , M.ATRZ_DMND_STTS_CD					-- 결재요청상세코드
		     , M.STEP_CD AS ATRZ_DMND_STTS_CD_NM
		     , M.ATRZ_STTS_CD						-- 결재상태코드 
		     , M.STTS_CD AS ATRZ_STTS_CD_NM
		     , M.NOW_ATRZ_LN_SN						-- 현재결재선순번
		     , C.CLM_ATRZ_DTL_SN					-- 청구결재상세순번
		     , M.ATRZ_FORM_DOC_ID					-- 결재양식문서ID
		     , M.APRVR_EMP_ID
		     , M.ATRZ_DMND_EMP_NM					-- 기안자
		     , M.APRVR_EMP_NM						-- 현재결재권자
		     , DATE_FORMAT(M.REG_DT, '%Y-%m-%d') AS REG_DT 	-- 요청일자
		     , M.GNRL_ATRZ_TTL
		     , COALESCE(C.CLM_ATRZ_TTL, CA.CTRT_ATRZ_TTL, CGA.ATRZ_TTL, GA.GNRL_ATRZ_TTL,
			   CONCAT((SELECT CD_NM FROM CD WHERE CD_VALUE = VA.VCATN_TY_CD), ' [', VA.VCATN_BGNG_YMD, ' ~ ', VA.VCATN_END_YMD, ' (', VA.VCATN_DE_CNT, '일)]')) AS TITLE
		     , C.CNPT_NM							-- 청구결재 거래처
		     , COALESCE(GA.GNRL_ATRZ_CN, C.CLM_ATRZ_CN, CA.CTRT_ATRZ_CN, CGA.STLM_CN) AS CN
		     , COUNT(*) OVER () AS TOTAL_ITEMS
		  FROM (
					SELECT EA.ELCTRN_ATRZ_ID
					     , EA.PRJCT_ID
					     , EA.ELCTRN_ATRZ_TY_SE_CD
					     , CD1.CD_NM AS TY_CD
					     , EA.ATRZ_DMND_STTS_CD
					     , CD2.CD_NM AS STEP_CD
					     , EA.NOW_ATRZ_LN_SN
					     , AL.ATRZ_STTS_CD
					     , CD3.CD_NM AS STTS_CD
					     , EA.ATRZ_FORM_DOC_ID
					     , AL.APRVR_EMP_ID
					     , E1.EMP_FLNM AS ATRZ_DMND_EMP_NM		-- 기안자
					     , E2.EMP_FLNM AS APRVR_EMP_NM			-- 현재 결재권자
					     , EADF.GNRL_ATRZ_TTL
					     , EA.REG_DT
					  FROM ELCTRN_ATRZ EA
					  LEFT JOIN ATRZ_LN AL ON EA.ELCTRN_ATRZ_ID = AL.ELCTRN_ATRZ_ID AND EA.NOW_ATRZ_LN_SN = AL.ATRZ_LN_SN
					  INNER JOIN EMP E1 ON EA.ATRZ_DMND_EMP_ID = E1.EMP_ID
					  INNER JOIN EMP E2 ON AL.APRVR_EMP_ID = E2.EMP_ID
					  LEFT JOIN ELCTRN_ATRZ_DOC_FORM EADF ON EA.ATRZ_FORM_DOC_ID = EADF.ATRZ_FORM_DOC_ID
					  LEFT JOIN CD CD1 ON EA.ELCTRN_ATRZ_TY_SE_CD = CD1.CD_VALUE
					  LEFT JOIN CD CD2 ON EA.ATRZ_DMND_STTS_CD = CD2.CD_VALUE
					  LEFT JOIN CD CD3 ON AL.ATRZ_STTS_CD = CD3.CD_VALUE
					  LEFT JOIN CD CD4 ON AL.APRVR_EMP_ID = CD4.CD_VALUE
		        ) M
		 LEFT JOIN (
		 			 SELECT  CA.ELCTRN_ATRZ_ID
					       , CAD.CLM_ATRZ_DTL_SN
					       , CA.CLM_ATRZ_TTL
					       , CAD.CNPT_NM
					       , CA.ATCHMNFL_ID
					       , CA.CLM_ATRZ_CN
					   FROM CLM_ATRZ CA
					  INNER JOIN CLM_ATRZ_DTL CAD ON CA.ELCTRN_ATRZ_ID = CAD.ELCTRN_ATRZ_ID
				      WHERE CAD.CLM_ATRZ_DTL_SN = (
				     							    SELECT MAX(CAD2.CLM_ATRZ_DTL_SN)
				     							      FROM CLM_ATRZ_DTL CAD2
				     							     INNER JOIN CLM_ATRZ CA ON CA.ELCTRN_ATRZ_ID = CAD.ELCTRN_ATRZ_ID 
				     							   ) 
		 		    ) C ON M.ELCTRN_ATRZ_ID = C.ELCTRN_ATRZ_ID
		 LEFT JOIN VCATN_ATRZ VA ON M.ELCTRN_ATRZ_ID = VA.ELCTRN_ATRZ_ID
		 LEFT JOIN CTRT_ATRZ CA ON M.ELCTRN_ATRZ_ID = CA.ELCTRN_ATRZ_ID
		 LEFT JOIN CTRT_GIVE_ATRZ CGA ON M.ELCTRN_ATRZ_ID = CGA.ELCTRN_ATRZ_ID  
		 LEFT JOIN GNRL_ATRZ GA ON M.ELCTRN_ATRZ_ID = GA.ELCTRN_ATRZ_ID 
		 WHERE 1=1
		<choose>
			<when test="searchType != null and searchType == 'progress'">
				AND (ATRZ_STTS_CD = 'VTW00801' OR ATRZ_DMND_STTS_CD = 'VTW03702')
			</when>
			<when test="searchType != null and searchType == 'terminatedAprvrEmp'">
				AND (ATRZ_STTS_CD = 'VTW00802' OR ATRZ_DMND_STTS_CD = 'VTW03703')
			</when>
			<when test="searchType != null and searchType == 'deny'">
				AND (ATRZ_STTS_CD = 'VTW00803' OR ATRZ_DMND_STTS_CD = 'VTW03704')
			</when>
		</choose>
		<!-- 검색 조건 -->
		<if test="prjctId != null">
			AND PRJCT_ID = #{prjctId}
		</if>
		<if test="elctrnAtrzTySeCd != null">
			AND ELCTRN_ATRZ_TY_SE_CD = #{elctrnAtrzTySeCd}
		</if>
		<if test="atrzDmndEmpNm != null">
			AND ATRZ_DMND_EMP_NM LIKE CONCAT('%', LOWER(#{atrzDmndEmpNm}), '%')
		</if>
		<if test="cnptNm != null">
			AND CNPT_NM LIKE CONCAT('%', LOWER(#{cnptNm}), '%')
		</if>
		<if test="title != null">
			AND (
			LOWER(GA.GNRL_ATRZ_TTL) LIKE CONCAT('%', LOWER(#{title}), '%') OR
			LOWER(C.CLM_ATRZ_TTL) LIKE CONCAT('%', LOWER(#{title}), '%') OR
			LOWER(CA.CTRT_ATRZ_CN) LIKE CONCAT('%', LOWER(#{title}), '%') OR
			LOWER(CGA.ATRZ_TTL) LIKE CONCAT('%', LOWER(#{title}), '%') OR
			LOWER(VA.VCATN_TY_CD) IN (SELECT CD_VALUE FROM CD WHERE LOWER(CD_NM) LIKE CONCAT('%', LOWER(#{title}), '%'))
			)
		</if>
	</select>
	
	<!-- 전자결재(관리자메뉴) 카운트 쿼리  -->
	<select id="elecAtrzMngCount" parameterType="map" resultType="com.trsystem.LowerHashMap">
   		SELECT 
			   (
				 SELECT COUNT(*) 
				   FROM ELCTRN_ATRZ EA
				  INNER JOIN ATRZ_LN AL ON EA.ELCTRN_ATRZ_ID = AL.ELCTRN_ATRZ_ID AND EA.NOW_ATRZ_LN_SN = AL.ATRZ_LN_SN
				  WHERE AL.ATRZ_STTS_CD = 'VTW00801' OR EA.ATRZ_DMND_STTS_CD = 'VTW03702'
			   ) AS PROGRESS
			 , (
				 SELECT COUNT(*) 
				   FROM ELCTRN_ATRZ EA
				  INNER JOIN ATRZ_LN AL ON EA.ELCTRN_ATRZ_ID = AL.ELCTRN_ATRZ_ID AND EA.NOW_ATRZ_LN_SN = AL.ATRZ_LN_SN
				  WHERE AL.ATRZ_STTS_CD = 'VTW00802' OR EA.ATRZ_DMND_STTS_CD = 'VTW03703' 
			   ) AS TERMINATED_APRVR_EMP
			 , (
				 SELECT COUNT(*) 
				   FROM ELCTRN_ATRZ EA
				  INNER JOIN ATRZ_LN AL ON EA.ELCTRN_ATRZ_ID = AL.ELCTRN_ATRZ_ID AND EA.NOW_ATRZ_LN_SN = AL.ATRZ_LN_SN
				  WHERE AL.ATRZ_STTS_CD = 'VTW00803' OR EA.ATRZ_DMND_STTS_CD = 'VTW03704' 	 
			   ) AS DENY
		  FROM DUAL
	</select>
	
	<!-- 전자결재 첨부파일 Id SELECT 쿼리  -->
	<select id="retrieveElecAtrzAtchmnFl" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT CASE WHEN VA.ATCHMNFL_ID IS NOT NULL THEN VA.ATCHMNFL_ID
		            WHEN CTA.ATCHMNFL_ID IS NOT NULL THEN CTA.ATCHMNFL_ID
					WHEN CGA.ATCHMNFL_ID IS NOT NULL THEN CGA.ATCHMNFL_ID
					WHEN GA.ATCHMNFL_ID IS NOT NULL THEN GA.ATCHMNFL_ID
					WHEN CA.ATCHMNFL_ID IS NOT NULL THEN CA.ATCHMNFL_ID
					ELSE '' END AS ATCHMNFL_ID
		  FROM ELCTRN_ATRZ EA
		  LEFT JOIN VCATN_ATRZ VA ON EA.ELCTRN_ATRZ_ID = VA.ELCTRN_ATRZ_ID
		  LEFT JOIN CTRT_ATRZ CTA ON EA.ELCTRN_ATRZ_ID = CTA.ELCTRN_ATRZ_ID
		  LEFT JOIN CTRT_GIVE_ATRZ CGA ON EA.ELCTRN_ATRZ_ID = CGA.ELCTRN_ATRZ_ID  
		  LEFT JOIN GNRL_ATRZ GA ON EA.ELCTRN_ATRZ_ID = GA.ELCTRN_ATRZ_ID
		  LEFT JOIN CLM_ATRZ CA ON EA.ELCTRN_ATRZ_ID = CA.ELCTRN_ATRZ_ID
		 WHERE EA.ELCTRN_ATRZ_ID = #{elctrnAtrzId}
	</select>
</mapper>
