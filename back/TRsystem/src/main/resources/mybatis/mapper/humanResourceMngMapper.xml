<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
        
<mapper namespace="com.trsystem.mybatis.mapper.humanResourceMngMapper">

    <!--==================1.부서 관리==================-->
    <!--부서 목록 조회-->
  	<select id="retrieveDeptList" parameterType="map" resultType="com.trsystem.LowerHashMap"> 
	    SELECT
	          ROW_NUMBER()OVER ()ROWNUM
	        , DEPT_ID  
	        , DEPT_NM                                                                                   -- 부서명
	        , UP_DEPT_ID
	        , (SELECT d2.DEPT_NM FROM DEPT d2 WHERE d.UP_DEPT_ID = d2.DEPT_ID) AS UP_DEPT_NM            -- 상위부서명
	        , (SELECT EMP_FLNM
				FROM (SELECT e.EMP_FLNM
					         , ROW_NUMBER() OVER (ORDER BY h.JBTTL_CD) AS RN
					    FROM EMP e
					    INNER JOIN DEPT_HNF h ON e.EMP_ID = h.EMP_ID
					    WHERE h.DEPT_ID = d.DEPT_ID) a
				WHERE RN = 1) AS DEPT_MNGR_EMP_FLNM                                                     -- 부서장명
	        , DEPT_BGNG_YMD                                                                             -- 부서시작일자
	        , DEPT_END_YMD                                                                              -- 부서종료일자
	        , COUNT(*) OVER () AS TOTAL_ITEMS                                                           -- 총건수
	     FROM DEPT d
	     WHERE 1=1 
		<if test="deptNm!= null and !deptNm.equals('')">
			AND DEPT_NM LIKE CONCAT('%',#{deptNm},'%')
		</if>
        <if test="deptMngrEmpFlnm!= null and !deptMngrEmpFlnm.equals('')">
			AND (SELECT EMP_FLNM
		           FROM (SELECT e.EMP_FLNM
		                         , ROW_NUMBER() OVER (ORDER BY h.JBTTL_CD) AS RN
		                    FROM EMP e
		                    INNER JOIN DEPT_HNF h ON e.EMP_ID = h.EMP_ID
		                    WHERE h.DEPT_ID = d.DEPT_ID) a
		            WHERE RN = 1
		        ) LIKE CONCAT('%',#{deptMngrEmpFlnm},'%')
		</if>
        <if test="deptBgngYmd != null and bizEndYmd == null">
			AND DEPT_BGNG_YMD > #{deptBgngYmd}
		</if>
        <if test="deptBgngYmd == null and deptEndYmd != null">
			AND DEPT_END_YMD > #{deptEndYmd}
		</if>
        <if test="deptBgngYmd != null and deptEndYmd != null">
			<if test="!deptBgngYmd.equals('') and !deptEndYmd.equals('')">
				AND DEPT_BGNG_YMD BETWEEN #{deptBgngYmd} AND #{deptEndYmd}
			</if>
		</if>
		ORDER BY REG_DT DESC </select>
		
	   <!--부서 상세 조회-->
  	   <select id="getDeptDetail" parameterType="map" resultType="com.trsystem.LowerHashMap"> 
	   SELECT d.DEPT_ID  
	        , d.DEPT_NM                                                                                   -- 부서명
	        , (SELECT d2.DEPT_NM FROM DEPT d2 WHERE d.UP_DEPT_ID = d2.DEPT_ID) AS UP_DEPT_NM              -- 상위부서명
	        , (SELECT a.EMP_FLNM
				FROM (SELECT e.EMP_FLNM
					         , ROW_NUMBER() OVER (ORDER BY h.JBTTL_CD) AS RN
					    FROM EMP e
					    INNER JOIN DEPT_HNF h ON e.EMP_ID = h.EMP_ID
					    WHERE h.DEPT_ID = d.DEPT_ID) a
				WHERE RN = 1) AS DEPT_MNGR_EMP_FLNM                                                       -- 부서장명
	        , d.DEPT_BGNG_YMD                                                                             -- 부서시작일자
	        , d.DEPT_END_YMD                                                                              -- 부서종료일자
	     FROM DEPT d
	     WHERE 1=1 
	       AND d.DEPT_ID = #{deptId}
		</select>
		
	<!--휴가배정관리-->
<!--	<select id="retrieveEmpVcatnInfo" parameterType="map" resultType="com.trsystem.LowerHashMap">-->
<!--		SELECT *-->
<!--		FROM (-->
<!--			SELECT-->
<!--				EMP.EMPNO-->
<!--				,EMP.EMP_FLNM-->
<!--				,(SELECT CD_VALUE FROM CD WHERE EMP.JBPS_CD = CD.CD_VALUE)			JOB_CD-->
<!--				,(SELECT CD_NM FROM CD WHERE EMP.JBPS_CD = CD.CD_VALUE)				JOB_NM-->
<!--				,DEPT.DEPT_ID-->
<!--				,DEPT.DEPT_NM-->
<!--				,VMNG.VCATN_ALTMNT_DAYCNT-->
<!--				,VMNG.USE_DAYCNT-->
<!--				,(VMNG.VCATN_ALTMNT_DAYCNT - VMNG.USE_DAYCNT)						REMAIN_DAYCNT-->
<!--				,(SELECT CD_VALUE  FROM CD WHERE EMP.HDOF_STTS_CD = CD.CD_VALUE)	HDOF_STTS_CD-->
<!--				,(SELECT CD_NM FROM CD WHERE EMP.HDOF_STTS_CD = CD.CD_VALUE)		HDOF_STTS_NM-->
<!--				,CAR.WORK_BGNG_YMD-->
<!--				,CASE WHEN DATEDIFF(DATE_FORMAT(CONCAT(DATE_FORMAT(NOW(), '%Y'), '0401'), '%Y%m%d'), CAR.WORK_BGNG_YMD) > 365 THEN 'ACC_YEAR'-->
<!--					ELSE 'BGNG_YEAR'-->
<!--					END FLAG_DATE-->
<!--				,VMNG.VCATN_YR-->
<!--				,CASE WHEN DATEDIFF(DATE_FORMAT(NOW(), '%Y%m%d'), DATE_FORMAT(CONCAT(DATE_FORMAT(NOW(), '%Y'), '0401'), '%Y%m%d')) <![CDATA[<]]> 0 THEN DATE_FORMAT(NOW(), '%Y') - 1-->
<!--					ELSE DATE_FORMAT(NOW(), '%Y')-->
<!--					END FLAG_YEAR-->
<!--			FROM VCATN_MNG	VMNG-->
<!--			RIGHT JOIN EMP EMP ON EMP.EMP_ID = VMNG.EMP_ID-->
<!--			LEFT JOIN DEPT_HNF HNF ON HNF.EMPNO = EMP.EMPNO-->
<!--			LEFT JOIN DEPT DEPT ON DEPT.DEPT_ID = HNF.DEPT_ID-->
<!--			JOIN EMP_CAREER CAR ON CAR.EMP_ID = EMP.EMP_ID-->
<!--		) A-->
<!--		WHERE 1 = 1-->
<!--		<if test="vcatnYr == null or vcatnYr.equals('')">-->
<!--			AND VCATN_YR = FLAG_YEAR-->
<!--		</if>-->
<!--		<if test="vcatnYr != null and !vcatnYr.equals('')">-->
<!--			AND VCATN_YR = #{vcatnYr}-->
<!--		</if>-->
<!--		<if test="empno != null and !empno.equals('')">-->
<!--			AND EMPNO LIKE CONCAT('%', #{empno}, '%')-->
<!--		</if>-->
<!--		<if test="empFlnm != null and !empFlnm.equals('')">-->
<!--			AND EMP_FLNM LIKE CONCAT('%', #{empFlnm}, '%')-->
<!--		</if>-->
<!--		<if test="jobCd != null and !jobCd.equals('')">-->
<!--			AND JOB_CD  = #{jobCd}-->
<!--		</if>-->
<!--		<if test="deptCd != null and !deptCd.equals('')">-->
<!--			AND DEPT_ID = #{deptCd}-->
<!--		</if>-->
<!--		<if test="hdofSttsCd != null and !hdofSttsCd.equals('')">-->
<!--			AND HDOF_STTS_CD = #{hdofSttsCd}-->
<!--		</if>-->
<!--		ORDER BY EMPNO-->
<!--	</select>-->

		<!--부서 인력 조회-->
		<select id="retrieveDownDeptList" parameterType="map" resultType="com.trsystem.LowerHashMap">
			SELECT d.DEPT_ID
                 , d.DEPT_NM
                 , (SELECT EMP_FLNM
				      FROM (SELECT e.EMP_FLNM
					             , ROW_NUMBER() OVER (ORDER BY h.JBTTL_CD) AS RN
					          FROM EMP e
					         INNER JOIN DEPT_HNF h ON e.EMP_ID = h.EMP_ID
					         WHERE h.DEPT_ID = d.DEPT_ID) a
				      WHERE RN = 1) AS DEPT_MNGR_EMP_FLNM
              FROM DEPT d
             WHERE d.UP_DEPT_ID = #{deptId}
		</select>









		<select id="retrieveDeptHnfList" parameterType="map" resultType="com.trsystem.LowerHashMap">
			SELECT e.EMP_ID
			       , e.EMPNO
			       , e.EMP_FLNM
			       , ( SELECT c.CD_NM
			             FROM CD c
                        WHERE c.CD_VALUE = e.JBPS_CD) AS JBPS_NM                                          -- 직위
                   , ( SELECT c.CD_NM
			             FROM CD c
                        WHERE c.CD_VALUE = h.JBTTL_CD) AS JBTTL_NM                                        -- 직책
		      FROM EMP e
		     INNER JOIN DEPT_HNF h ON e.EMP_ID = h.EMP_ID
		     WHERE h.DEPT_ID = #{deptId}
		</select>







	<!-- 휴가사용내역 -->
	<select id="retrieveEmpVacUseList" parameterType="map" resultType="com.trsystem.LowerHashMap">

    SELECT
		 (SELECT CD_NM FROM CD WHERE CD_VALUE = va.VCATN_TY_CD) AS VCATN_TY_CD -- 휴가구분
 		,(SELECT EMPNO FROM  EMP WHERE EMP_ID IN (SELECT ATRZ_DMND_EMP_ID  FROM ELCTRN_ATRZ ea WHERE ea.ELCTRN_ATRZ_ID = va.ELCTRN_ATRZ_ID ) ) as EMPNO -- 사원번호
 		,(SELECT EMP_FLNM FROM EMP WHERE EMP_ID IN (SELECT ATRZ_DMND_EMP_ID  FROM ELCTRN_ATRZ ea WHERE ea.ELCTRN_ATRZ_ID = va.ELCTRN_ATRZ_ID  ) ) as EMP_FLNM -- 사원명
		, STR_TO_DATE(VCATN_BGNG_YMD, '%Y%m%d')  VCATN_BGNG_YMD -- 시작일
		, STR_TO_DATE(VCATN_END_YMD, '%Y%m%d')  VCATN_END_YMD -- 종료일
		, VCATN_DE_CNT -- 휴가일수
		, VCATN_PRVONSH -- 휴가사유
        , COUNT(*) OVER () AS TOTAL_ITEMS
     FROM
     VCATN_ATRZ va     	   <!--휴가결재 테이블-->
 	 WHERE 1=1
        <if test="vcatnBgngYmd != null and vcatnEndYmd == null">
      		AND VCATN_BGNG_YMD > #{vcatnBgngYmd}
        </if>
        <if test="vcatnBgngYmd == null and vcatnEndYmd != null">
      		AND VCATN_END_YMD > #{vcatnEndYmd}
        </if>
        <if test="vcatnBgngYmd != null and vcatnEndYmd != null">
           <if test="!vcatnBgngYmd.equals('') and !vcatnEndYmd.equals('')">
     		AND VCATN_BGNG_YMD BETWEEN #{vcatnBgngYmd} AND #{vcatnEndYmd}
           </if>
        </if>
      <if test="empno !=null and !empno.equals('')">
     	HAVING
        EMPNO = #{empno}
      </if>
    </select>


    <!-- 회의실정보 -->
	<select id="retrieveMnbyVcatnInfo" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            CONCAT(EMP.EMP_FLNM, '(', CD.CD_NM, ')') TITLE
            ,CD.CD_NM
            ,VCATN.VCATN_BGNG_YMD DATE
            ,VCATN_END_YMD
            ,SUBSTR(VCATN.VCATN_BGNG_YMD, 5, 2)	VCATN_MONTH
            ,VCATN.VCATN_DE_CNT
            ,VCATN.ELCTRN_ATRZ_ID
            ,EMP.EMPNO
        FROM
            VCATN_ATRZ		VCATN
            ,ELCTRN_ATRZ	ELCTRN
            ,EMP			EMP
            ,CD 			CD
        WHERE VCATN.ELCTRN_ATRZ_ID = ELCTRN.ELCTRN_ATRZ_ID
        AND	EMP.EMP_ID = ATRZ_DMND_EMP_ID
        AND VCATN.VCATN_TY_CD = CD.CD_VALUE
        <if test="empno !=null and !empno.equals('')">
            AND EMP.EMPNO = #{empno}
        </if>
    </select>


	<!-- 회의참석자 -->
    <select id="retrieveMtgRoomInfoInq" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
			RSVT.RSVT_EMP_ID
			,EMP.EMP_FLNM 												RSVT_EMP_FLNM
			,STR_TO_DATE(CONCAT(USE_YMD, USE_BGNG_HM), '%Y%m%d%H%i%s')  START_DATE
			,STR_TO_DATE(CONCAT(USE_YMD, USE_END_HM), '%Y%m%d%H%i%s')   END_DATE
			,RSVT.MTG_TTL
        FROM
            MTG_ROOM_RSVT           RSVT
            ,EMP                    EMP
            ,CD                     CD
        WHERE RSVT.MTG_ROOM_CD = CD.CD_VALUE
        AND RSVT.REG_EMP_ID = EMP.EMPNO
        AND EXISTS (
                    SELECT 1
                    FROM MTG_ROOM_RSVT_ATDRN    ATDRN
                    WHERE RSVT.MTG_ROOM_RSVT_SN = ATDRN.MTG_ROOM_RSVT_SN
        )
    </select>



	<!-- 직원별휴가정보조회 -->
	<select id="retrieveMtgAtdrnInq" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT
			ATDRN.MTG_ROOM_RSVT_SN
			,ATDRN.ATND_EMP_ID
			,EMP.EMP_FLNM
		FROM
			MTG_ROOM_RSVT			RSVT
			,MTG_ROOM_RSVT_ATDRN	ATDRN
			,EMP					EMP
		WHERE RSVT.MTG_ROOM_RSVT_SN = ATDRN.MTG_ROOM_RSVT_SN
		AND ATDRN.ATND_EMP_ID = EMP.EMPNO
		<if test="mtgRoomRsvtSn !=null and !mtgRoomRsvtSn.equals('')">
			AND MTG_ROOM_RSVT_SN = #{mtgRoomRsvtSn}
		</if>
    </select>



	<!--휴가배정관리-->
	<select id="retrieveEmpVcatnInfo" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT *
		FROM (
			SELECT
				EMP.EMP_ID
				,EMP.EMPNO
				,EMP.EMP_FLNM
				,(SELECT CD_VALUE FROM CD WHERE EMP.JBPS_CD = CD.CD_VALUE)			JOB_CD
				,(SELECT CD_NM FROM CD WHERE EMP.JBPS_CD = CD.CD_VALUE)				JOB_NM
				,DEPT.DEPT_ID
				,DEPT.DEPT_NM
				,(SELECT CD_VALUE  FROM CD WHERE EMP.HDOF_STTS_CD = CD.CD_VALUE)	HDOF_STTS_CD
				,(SELECT CD_NM FROM CD WHERE EMP.HDOF_STTS_CD = CD.CD_VALUE)		HDOF_STTS_NM
				,VMNG.VCATN_ALTMNT_SN
				,VMNG.VCATN_YR
				,VMNG.VCATN_ALTMNT_DAYCNT
				,VMNG.USE_DAYCNT
				,VMNG.VCATN_REMNDR_DAYCNT
				,VMNG.NEW_VCATN_ALTMNT_DAYCNT
				,VMNG.NEW_USE_DAYCNT
				,VMNG.NEW_REMNDR_DAYCNT
				,VMNG.ALTMNT_BGNG_YMD
				,VMNG.ALTMNT_USE_END_YMD
				,CASE WHEN DATEDIFF(DATE_FORMAT(NOW(), '%Y%m%d'), DATE_FORMAT(CONCAT(DATE_FORMAT(NOW(), '%Y'), '0401'), '%Y%m%d')) <![CDATA[<]]> 0 THEN DATE_FORMAT(NOW(), '%Y') - 1
					ELSE DATE_FORMAT(NOW(), '%Y')
					END FLAG_YEAR
			FROM VCATN_MNG	VMNG
			RIGHT JOIN EMP EMP ON EMP.EMP_ID = VMNG.EMP_ID
			LEFT JOIN DEPT_HNF HNF ON HNF.EMPNO = EMP.EMPNO
			LEFT JOIN DEPT DEPT ON DEPT.DEPT_ID = HNF.DEPT_ID
		) A
		WHERE 1 = 1
		<if test="vcatnYr == null or vcatnYr.equals('')">
			AND VCATN_YR = FLAG_YEAR
		</if>
		<if test="vcatnYr != null and !vcatnYr.equals('')">
			AND VCATN_YR = #{vcatnYr}
		</if>
		<if test="empno != null and !empno.equals('')">
			AND EMPNO LIKE CONCAT('%', #{empno}, '%')
		</if>
		<if test="empFlnm != null and !empFlnm.equals('')">
			AND EMP_FLNM LIKE CONCAT('%', #{empFlnm}, '%')
		</if>
		<if test="jobCd != null and !jobCd.equals('')">
			AND JOB_CD  = #{jobCd}
		</if>
		<if test="deptCd != null and !deptCd.equals('')">
			AND DEPT_ID = #{deptCd}
		</if>
		<if test="hdofSttsCd != null and !hdofSttsCd.equals('')">
			AND HDOF_STTS_CD = #{hdofSttsCd}
		</if>
		ORDER BY EMPNO
	</select>

	
	
	<!-- 직원별휴가정보조회 (임시사용)-->
	<select id="retrieveEmpnoMax" parameterType="map" resultType="com.trsystem.LowerHashMap">
	SELECT 
		CONCAT(#{empnoChk},LPAD(MAX(substr(empno, 3))+1, '4', '0')) as  EMPNO_CHK
	FROM 
		EMP 
	WHERE  
		EMPNO LIKE CONCAT(#{empnoChk},'%');
	</select>

</mapper>	