<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.trsystem.mybatis.mapper.financialAffairMngMapper">
	
	<!-- 프로젝트 비용청구 현황 -->
    <select id="retrieveAllPrjctList" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT ROW_NUMBER()OVER ()ROWNUM
            , (SELECT CD_NM FROM CD WHERE CD_VALUE = PRJCT_STLE_CD) AS PRJCT_STLE_CD
            , p.PRJCT_ID
            , PRJCT_NM
            , (SELECT CD_NM FROM CD WHERE CD_VALUE = BIZ_STTS_CD) AS BIZ_STTS_CD_NM
            , BIZ_STTS_CD
            , (SELECT EMP_FLNM FROM EMP WHERE EMP_ID = PRJCT_MNGR_EMP_ID ) AS PRJCT_MNGR_EMP_ID
            , (SELECT CTMMNY_NM FROM CTMMNY_INFO ci WHERE ci.CTMMNY_ID = p.CTMMNY_ID) AS CTMMNY_NM
            , DATE_FORMAT(CTRT_YMD, '%Y-%m-%d') AS CTRT_YMD
            , DATE_FORMAT(BIZ_END_YMD, '%Y-%m-%d') AS BIZ_END_YMD
            , DATE_FORMAT(STBLE_END_YMD, '%Y-%m-%d') AS STBLE_END_YMD
            , COUNT(*) OVER () AS TOTAL_ITEMS
        FROM PRJCT p
        WHERE 1 = 1
        <if test="prjctStleCd != null and !prjctStleCd.equals('')">
	      AND PRJCT_STLE_CD = #{prjctStleCd}
        </if>
        <if test="prjctId != null and !prjctId.equals('')">
	      AND PRJCT_ID = #{prjctId}
        </if>
        <if test="bizFlfmtTyCd != null and !bizFlfmtTyCd.equals('')">
	      AND BIZ_FLFMT_TY_CD = #{bizFlfmtTyCd}
        </if>
        <if test="ctrtYmd != null and bizEndYmd == null">
	      AND CTRT_YMD >= #{ctrtYmd}
        </if>
        <if test="ctrtYmd == null and bizEndYmd != null">
	      AND BIZ_END_YMD &lt;= #{bizEndYmd}
        </if>
        <if test="ctrtYmd != null and bizEndYmd != null">
        <if test="!ctrtYmd.equals('') and !bizEndYmd.equals('')">
	      AND CTRT_YMD BETWEEN #{ctrtYmd} AND #{bizEndYmd}
        </if>
	    </if>
	    <if test="prjctNm != null and !prjctNm.equals('')">
          AND PRJCT_NM = #{prjctNm}
		</if>
        <if test="ctmmnyNm != null and !ctmmnyNm.equals('')">
          AND CTMMNY_ID IN (SELECT CTMMNY_ID FROM CTMMNY_INFO WHERE CTMMNY_NM LIKE CONCAT('%',#{ctmmnyNm},'%'))
   	 	</if>	
		ORDER BY p.REG_DT DESC
	</select>

    <!--프로젝트청구현황개인별 수행인력-->
    <select id="retrievePrjctCtClmSttusIndvdlMMAccto" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            pma.EMP_ID,
            d.DEPT_NM,
            e.EMP_FLNM,
            CONCAT(SUBSTR(#{startYmOdr},1, 6),'-',SUBSTR(#{startYmOdr}, 7, 1)) AS START_APLY_ODR,
            CONCAT(SUBSTR(#{endYmOdr},1, 6),'-',SUBSTR(#{endYmOdr}, 7, 1)) AS END_APLY_ODR,
            mm.EXPECT_MM,
            (
                SELECT SUM(a.MD*8) / 80
                FROM PRJCT_MM_APLY a
                WHERE a.PRJCT_ID = pma.PRJCT_ID
                GROUP BY a.PRJCT_ID
            ) AS TOTAL_MD_SUM,
            (mm.EXPECT_MM - (
                SELECT SUM(a.MD*8) / 80
                FROM PRJCT_MM_APLY a
                WHERE a.PRJCT_ID = pma.PRJCT_ID
                GROUP BY a.PRJCT_ID
            )) AS USE_MM,
            SUM(pma.MD*8) AS CLM_MD
        FROM PRJCT_MM_APLY pma
        JOIN PRJCT_INDVDL_CT_MM picm
            ON pma.PRJCT_ID = picm.PRJCT_ID
            AND pma.EMP_ID = picm.EMP_ID
            AND pma.APLY_YM = picm.APLY_YM
            AND pma.APLY_ODR = picm.APLY_ODR
            AND picm.MM_ATRZ_CMPTN_YN = 'Y'
        JOIN EMP e
            ON e.EMP_ID = picm.EMP_ID
        JOIN DEPT_HNF dh
            ON dh.EMP_ID = picm.EMP_ID
        JOIN DEPT d
            ON d.DEPT_ID = dh.DEPT_ID
        JOIN (
            SELECT
            mlp.EMP_ID,
            mim.EXPECT_MM,
            mlp.PRJCT_ID,
            mim.INPT_YM
            FROM MMNY_LBRCO_PRMPC mlp
            JOIN MMNY_INPT_MM mim
            ON mlp.PRJCT_ID = mim.PRJCT_ID
            AND mlp.BGT_MNG_ODR = mim.BGT_MNG_ODR
            AND mlp.MMNY_LBRCO_PRMPC_SN = mim.MMNY_LBRCO_PRMPC_SN
        ) mm
            ON mm.PRJCT_ID = picm.PRJCT_ID
            AND mm.EMP_ID = picm.EMP_ID
        WHERE 1 = 1
        <if test="prjctId != null and !prjctId.equals('')">
            AND pma.PRJCT_ID = #{prjctId}
        </if>
        <if test="empFlnm != null and !empFlnm.equals('')">
            AND e.EMP_FLNM = #{empFlnm}
        </if>
        <if test="(startYmOdr != null and !startYmOdr.equals('')) and (endYmOdr != null and !endYmOdr.equals(''))">
            AND CONCAT(pma.APLY_YM, pma.APLY_ODR) BETWEEN #{startYmOdr} AND #{endYmOdr}
        </if>
        <if test="empId != null and !empId.equals('')">
            AND pma.EMP_ID = #{empId}
        </if>
        GROUP BY pma.EMP_ID, d.DEPT_NM, e.EMP_FLNM, START_APLY_ODR, END_APLY_ODR, mm.EXPECT_MM, USE_MM
    </select>

    <!--프로젝트청구현황개인별 경비-->
    <select id="retrievePrjctCtClmSttusIndvdlCtAccto" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            (SELECT CD_NM FROM nwTr.CD cd WHERE UP_CD_VALUE = 'VTW045' AND CD_VALUE = pca.EXPENS_CD) AS EXPENS_NM,
            pca.EXPENS_CD,
            CONCAT(SUBSTR(#{startYmOdr},1, 6),'-',SUBSTR(#{startYmOdr}, 7, 1)) AS START_APLY_ODR,
            CONCAT(SUBSTR(#{endYmOdr},1, 6),'-',SUBSTR(#{endYmOdr}, 7, 1)) AS END_APLY_ODR,
            (
                SELECT SUM(a.UTZTN_AMT)
                FROM PRJCT_CT_APLY a
                WHERE a.EXPENS_CD = pca.EXPENS_CD
                AND a.PRJCT_ID = pca.PRJCT_ID
                GROUP BY a.EXPENS_CD
            ) AS TOTAL_AMT_SUM,
            SUM(pca.UTZTN_AMT) AS TOTAL_AMT
        FROM PRJCT_CT_APLY pca
        JOIN PRJCT_INDVDL_CT_MM picm
            ON pca.PRJCT_ID = picm.PRJCT_ID
            AND pca.EMP_ID  = picm.EMP_ID
            AND pca.APLY_YM = picm.APLY_YM
            AND pca.APLY_ODR = picm.APLY_ODR
            AND picm.CT_ATRZ_CMPTN_YN = 'Y'
        WHERE 1 = 1
        <if test="prjctId != null and !prjctId.equals('')">
            AND pca.PRJCT_ID = #{prjctId}
        </if>
        <if test="(startYmOdr != null and !startYmOdr.equals('')) and (endYmOdr != null and !endYmOdr.equals(''))">
            AND CONCAT(pca.APLY_YM, pca.APLY_ODR) BETWEEN #{startYmOdr} AND #{endYmOdr}
        </if>
        <if test="expensCd != null and !expensCd.equals('')">
            AND pca.EXPENS_CD = #{expensCd}
        </if>
        GROUP BY TOTAL_AMT_SUM, EXPENS_CD, START_APLY_ODR, END_APLY_ODR
    </select>

    <!-- 프로젝트청구현황개인별 수행인력 팝업 -->
    <select id="retrievePrjctCtClmSttusIndvdlMMAcctoDetail" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            pma.MD*8,
            CONCAT(pma.MD*8, 'hrs | ', e.EMP_FLNM, '(', c.CD_NM, ')') AS TEXT,
            c.CD_NM AS ATRZ_DMND_STTS_NM ,
            DATE_FORMAT(pma.APLY_YMD, '%Y-%m-%d') AS START_DATE,
            DATE_FORMAT(pma.APLY_YMD,'%Y-%m-%d') AS END_DATE,
            (SELECT EMP_FLNM FROM EMP WHERE EMP_ID = pah.APRVR_EMP_ID) AS APRVR_EMP_FLNM,
            d.DEPT_NM
        FROM PRJCT_MM_APLY pma
        JOIN PRJCT_MM_ATRZ pah
            ON pma.PRJCT_ID = pah.PRJCT_ID
            AND pma.EMP_ID = pah.EMP_ID
            AND pma.APLY_YM = pah.APLY_YM
            AND pma.APLY_ODR = pah.APLY_ODR
            AND pah.ATRZ_DMND_STTS_CD = 'VTW03703' -- 결재요청상태코드 : 승인
        JOIN EMP e
            ON pma.EMP_ID = e.EMP_ID
        JOIN CD c
            ON pah.ATRZ_DMND_STTS_CD = c.CD_VALUE
        JOIN DEPT_HNF dh
            ON dh.EMP_ID = e.EMP_ID
        JOIN DEPT d
            ON d.DEPT_ID = dh.DEPT_ID
        WHERE 1 = 1
        <if test="prjctId != null and !prjctId.equals('')">
            AND pma.PRJCT_ID = #{prjctId}
        </if>
        <if test="(startYmOdr != null and !startYmOdr.equals('')) and (endYmOdr != null and !endYmOdr.equals(''))">
            AND CONCAT(pma.APLY_YM, pma.APLY_ODR) BETWEEN #{startYmOdr} AND #{endYmOdr}
        </if>
        <if test="empId != null and !empId.equals('')">
            AND pma.EMP_ID = #{empId}
        </if>
    </select>

    <!-- 프로젝트청구현황개인별 경비팝업 -->
    <select id="retrievePrjctCtClmSttusIndvdlCtAcctoDetail" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            PIVOT_DATE,
            COALESCE(APLY_YMD, '') AS APLY_YMD,
            COALESCE(PRJCT_NM, 'null_project') AS PRJCT_NM,
            COALESCE(EMP_FLNM, 'null_flnm') AS EMP_FLNM,
            COALESCE(EMP_DETAIL, 'null_detail') AS EMP_DETAIL,
            COALESCE(CD_NM, 'null_cd') AS CD_NM,
            COALESCE(UTZTN_AMT, '') AS UTZTN_AMT
        FROM (
            WITH RECURSIVE a AS (
                SELECT CAST(CONCAT(SUBSTR(#{startYmOdr},1, 6), '01') AS DATE) AS PIVOT_DATE
                UNION ALL
                SELECT DATE_ADD(PIVOT_DATE, INTERVAL 1 DAY)
                FROM a
                WHERE DATE_ADD(PIVOT_DATE, INTERVAL 1 DAY) &lt; CAST(CONCAT(SUBSTR(#{endYmOdr}, 1, 6), '01') AS DATE) + INTERVAL 1 MONTH
            ), b AS (
                SELECT
                    CONCAT(SUBSTR(b.UTZTN_DT, 1, 4),'-',SUBSTR(b.UTZTN_DT, 5, 2),'-',SUBSTR(b.UTZTN_DT, 7, 2)) AS APLY_YMD,
                    p.PRJCT_NM,
                    (SELECT EMP_FLNM FROM nwTr.EMP emp WHERE EMP_ID = b.EMP_ID) AS EMP_FLNM,
                    CONCAT('상세내역 : ', b.CT_PRPOS, ' | 용도 : ', b.ATDRN) AS EMP_DETAIL,
                    null AS MD,
                    (SELECT CD_NM FROM nwTr.CD cd WHERE UP_CD_VALUE = 'VTW045' AND CD_VALUE = b.EXPENS_CD) AS CD_NM,
                    b.UTZTN_AMT,
                    b.USE_OFFIC,
                    b.CT_PRPOS,
                    b.ATDRN
                FROM nwTr.PRJCT_INDVDL_CT_MM a, nwTr.PRJCT_CT_APLY b
                JOIN PRJCT p
                ON b.PRJCT_ID = p.PRJCT_ID
                WHERE 1 = 1
                AND a.PRJCT_ID = b.PRJCT_ID
                AND a.APLY_YM = b.APLY_YM
                AND a.APLY_ODR = b.APLY_ODR
                AND a.EMP_ID = b.EMP_ID
                AND a.CT_ATRZ_CMPTN_YN = 'Y'
                <if test="prjctId != null and !prjctId.equals('')">
                    AND a.PRJCT_ID = #{prjctId}
                </if>
                <if test="(startYmOdr != null and !startYmOdr.equals('')) and (endYmOdr != null and !endYmOdr.equals(''))">
                    AND CONCAT(a.APLY_YM, a.APLY_ODR) BETWEEN #{startYmOdr} AND #{endYmOdr}
                </if>
                <if test="expensCd != null and !expensCd.equals('')">
                    AND b.EXPENS_CD = #{expensCd}
                </if>
            )
            SELECT * FROM (
                SELECT *
                FROM a
                WHERE (
                    (SUBSTR(#{startYmOdr},7, 1) = 1 AND PIVOT_DATE >= CONCAT(SUBSTR(#{startYmOdr},1, 6), '01')) OR
                    (SUBSTR(#{startYmOdr},7, 1) = 2 AND PIVOT_DATE >= CONCAT(SUBSTR(#{startYmOdr},1, 6), '16'))
                ) AND (
                    (SUBSTR(#{endYmOdr},7, 1) = 1 AND PIVOT_DATE &lt;= CONCAT(SUBSTR(#{endYmOdr},1, 6), '15')) OR
                    (CONCAT(SUBSTR(#{endYmOdr}, 7, 1) = 2 AND PIVOT_DATE &lt;= LAST_DAY(CAST(CONCAT(SUBSTR(#{endYmOdr}, 1, 6), '01') AS DATE))))
                )
            ) c
            LEFT JOIN b
                ON c.PIVOT_DATE = b.APLY_YMD
        ) a
        ORDER BY PIVOT_DATE
    </select>

    <!-- 프로젝트청구현황일자별 -->
    <select id="retrievePrjctCtClmYMDAccto" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            PIVOT_DATE,
            COALESCE(APLY_YMD, '') AS APLY_YMD,
            COALESCE(PRJCT_NM, 'null_project') AS PRJCT_NM,
            COALESCE(EMP_FLNM, 'null_flnm') AS EMP_FLNM,
            COALESCE(EMP_DETAIL, 'null_detail') AS EMP_DETAIL,
            COALESCE(MD, '') AS MD,
            COALESCE(CD_NM, 'null_cd') AS CD_NM,
            COALESCE(UTZTN_AMT, '') AS UTZTN_AMT,
            COALESCE(USE_OFFIC, '') AS USE_OFFIC,
            COALESCE(CT_PRPOS, '') AS CT_PRPOS,
            COALESCE(ATDRN, '') AS ATDRN
        FROM (
        WITH RECURSIVE a AS (
            SELECT
                CONCAT(SUBSTR(b.APLY_YMD, 1, 4),'-',SUBSTR(b.APLY_YMD, 5, 2),'-',SUBSTR(b.APLY_YMD, 7, 2)) AS APLY_YMD,
                p.PRJCT_NM,
                (SELECT EMP_FLNM FROM nwTr.EMP emp WHERE EMP_ID = b.EMP_ID) AS EMP_FLNM,
                '' AS EMP_DETAIL,
                FORMAT(b.MD*8, 1) AS MD,
                '근무 시간' AS CD_NM,
                null AS UTZTN_AMT,
                null AS USE_OFFIC,
                null AS CT_PRPOS,
                null AS ATDRN
            FROM nwTr.PRJCT_INDVDL_CT_MM a, nwTr.PRJCT_MM_APLY b
            JOIN PRJCT p
                ON b.PRJCT_ID = p.PRJCT_ID
            WHERE 1 = 1
                AND a.PRJCT_ID = b.PRJCT_ID
                AND a.APLY_YM = b.APLY_YM
                AND a.APLY_ODR = b.APLY_ODR
                AND a.EMP_ID = b.EMP_ID
                AND a.MM_ATRZ_CMPTN_YN = 'Y'
            <if test="prjctId != null and !prjctId.equals('')">
                AND a.PRJCT_ID = #{prjctId}
            </if>
            <if test="empId != null and !empId.equals('')">
                AND a.EMP_ID = #{empId}
            </if>
            <if test="(startYmOdr != null and !startYmOdr.equals('')) and (endYmOdr != null and !endYmOdr.equals(''))">
                AND CONCAT(a.APLY_YM, a.APLY_ODR) BETWEEN #{startYmOdr} AND #{endYmOdr}
            </if>
        ), b AS (
            SELECT
                CONCAT(SUBSTR(b.UTZTN_DT, 1, 4),'-',SUBSTR(b.UTZTN_DT, 5, 2),'-',SUBSTR(b.UTZTN_DT, 7, 2)) AS APLY_YMD,
                p.PRJCT_NM,
                (SELECT EMP_FLNM FROM nwTr.EMP emp WHERE EMP_ID = b.EMP_ID) AS EMP_FLNM,
                CONCAT('상세내역 : ', b.CT_PRPOS, ' | 용도 : ', b.ATDRN) AS EMP_DETAIL,
                null AS MD,
                (SELECT CD_NM FROM nwTr.CD cd WHERE UP_CD_VALUE = 'VTW045' AND CD_VALUE = b.EXPENS_CD) AS CD_NM,
                b.UTZTN_AMT,
                b.USE_OFFIC,
                b.CT_PRPOS,
                b.ATDRN
            FROM nwTr.PRJCT_INDVDL_CT_MM a, nwTr.PRJCT_CT_APLY b
            JOIN PRJCT p
                ON b.PRJCT_ID = p.PRJCT_ID
            WHERE 1 = 1
                AND a.PRJCT_ID = b.PRJCT_ID
                AND a.APLY_YM = b.APLY_YM
                AND a.APLY_ODR = b.APLY_ODR
                AND a.EMP_ID = b.EMP_ID
                AND a.MM_ATRZ_CMPTN_YN = 'Y'
            <if test="prjctId != null and !prjctId.equals('')">
                AND a.PRJCT_ID = #{prjctId}
            </if>
            <if test="empId != null and !empId.equals('')">
                AND a.EMP_ID = #{empId}
            </if>
            <if test="(startYmOdr != null and !startYmOdr.equals('')) and (endYmOdr != null and !endYmOdr.equals(''))">
                AND CONCAT(a.APLY_YM, a.APLY_ODR) BETWEEN #{startYmOdr} AND #{endYmOdr}
            </if>
        ), c AS (
            SELECT CAST(CONCAT(SUBSTR(#{startYmOdr},1, 6), '01') AS DATE) AS PIVOT_DATE
            UNION ALL
            SELECT DATE_ADD(PIVOT_DATE, INTERVAL 1 DAY)
            FROM c
            WHERE DATE_ADD(PIVOT_DATE, INTERVAL 1 DAY) &lt; CAST(CONCAT(SUBSTR(#{endYmOdr}, 1, 6), '01') AS DATE) + INTERVAL 1 MONTH
        )
        SELECT * FROM (
            SELECT *
            FROM c
            WHERE (
                (SUBSTR(#{startYmOdr},7, 1) = 1 AND PIVOT_DATE >= CONCAT(SUBSTR(#{startYmOdr},1, 6), '01')) OR
                (SUBSTR(#{startYmOdr},7, 1) = 2 AND PIVOT_DATE >= CONCAT(SUBSTR(#{startYmOdr},1, 6), '16'))
                ) AND (
                (SUBSTR(#{endYmOdr},7, 1) = 1 AND PIVOT_DATE &lt;= CONCAT(SUBSTR(#{endYmOdr},1, 6), '15')) OR
                (CONCAT(SUBSTR(#{endYmOdr}, 7, 1) = 2 AND PIVOT_DATE &lt;= LAST_DAY(CAST(CONCAT(SUBSTR(#{endYmOdr}, 1, 6), '01') AS DATE))))
            )
        ) d
        LEFT JOIN a
            ON d.PIVOT_DATE = a.APLY_YMD
        UNION
        SELECT * FROM (
            SELECT *
            FROM c
            WHERE (
                (SUBSTR(#{startYmOdr},7, 1) = 1 AND PIVOT_DATE >= CONCAT(SUBSTR(#{startYmOdr},1, 6), '01')) OR
                (SUBSTR(#{startYmOdr},7, 1) = 2 AND PIVOT_DATE >= CONCAT(SUBSTR(#{startYmOdr},1, 6), '16'))
                ) AND (
                (SUBSTR(#{endYmOdr},7, 1) = 1 AND PIVOT_DATE &lt;= CONCAT(SUBSTR(#{endYmOdr},1, 6), '15')) OR
                (CONCAT(SUBSTR(#{endYmOdr}, 7, 1) = 2 AND PIVOT_DATE &lt;= LAST_DAY(CAST(CONCAT(SUBSTR(#{endYmOdr}, 1, 6), '01') AS DATE))))
            )
        ) d
        LEFT JOIN b
        ON d.PIVOT_DATE = b.APLY_YMD
        ) a
        ORDER BY PIVOT_DATE
    </select>

    <!-- 날짜 목록 -->
    <select id="retrieveDays" parameterType="map" resultType="com.trsystem.LowerHashMap">
    WITH RECURSIVE a AS (
        SELECT CAST(CONCAT(#{aplyYm}, '01') AS DATE) AS PIVOT_DATE
        UNION ALL
        SELECT DATE_ADD(PIVOT_DATE, INTERVAL 1 DAY)
        FROM a
        WHERE DATE_ADD(PIVOT_DATE, INTERVAL 1 DAY) &lt; CAST(CONCAT(#{aplyYm}, '01') AS DATE) + INTERVAL 1 MONTH
    )
    SELECT *
    FROM a
    <if test="aplyOdr != null and !aplyOdr.equals('')">
        WHERE (
        #{aplyOdr} = 1 AND DAY(PIVOT_DATE) &lt;= 15
        ) OR (
        #{aplyOdr} = 2 AND DAY(PIVOT_DATE) > 15 AND DAY(PIVOT_DATE) &lt;= DAY(LAST_DAY(PIVOT_DATE)))
    </if>
    </select>

    <!-- 경비 승인내역 -->
    <select id="retrieveExpensAprvDtls" parameterType="map" resultType="com.trsystem.LowerHashMap">
<!--        SELECT-->
<!--            PIVOT_DATE,-->
<!--            COALESCE(b.PRJCT_NM, 'null_project') AS PRJCT_NM,-->
<!--            COALESCE(b.EXPENS_CD, 'null_Cd') AS EXPENS_CD,-->
<!--            COALESCE(b.EMP_FLNM, 'null_flnm') AS EMP_FLNM,-->
<!--            COALESCE(b.PRJCT_DETAIL, 'null_info') AS PRJCT_DETAIL,-->
<!--            COALESCE(b.EMP_DETAIL, 'null_info') AS EMP_DETAIL,-->
<!--            COALESCE(b.UTZTN_AMT, 'null_amt') AS UTZTN_AMT,-->
<!--            COALESCE(b.UTZTN_DT, 'null_dt') AS UTZTN_DT-->
<!--        FROM (-->
<!--            WITH RECURSIVE a AS (-->
<!--            SELECT CAST(CONCAT(#{aplyYm}, '01') AS DATE) AS PIVOT_DATE-->
<!--            UNION ALL-->
<!--            SELECT DATE_ADD(PIVOT_DATE, INTERVAL 1 DAY)-->
<!--            FROM a-->
<!--            WHERE DATE_ADD(PIVOT_DATE, INTERVAL 1 DAY) &lt; CAST(CONCAT(#{aplyYm}, '01') AS DATE) + INTERVAL 1 MONTH-->
<!--        )-->
<!--        SELECT *-->
<!--        FROM a-->
<!--        <if test="aplyOdr != null and !aplyOdr.equals('')">-->
<!--            WHERE (-->
<!--            #{aplyOdr} = 1 AND DAY(PIVOT_DATE) &lt;= 15-->
<!--            ) OR (-->
<!--            #{aplyOdr} = 2 AND DAY(PIVOT_DATE) > 15 AND DAY(PIVOT_DATE) &lt;= DAY(LAST_DAY(PIVOT_DATE)))-->
<!--        </if>-->
<!--        ) a-->
<!--        LEFT JOIN (-->
            SELECT
                CONCAT(p.PRJCT_NM, ' (PM : ', (SELECT EMP_FLNM FROM EMP WHERE EMP_ID = pah.APRVR_EMP_ID), ')') AS PRJCT_NM,
                (SELECT CD_NM FROM CD WHERE CD_VALUE = pca.EXPENS_CD) AS EXPENS_CD,
                e.EMP_FLNM,
                CONCAT(e.EMP_FLNM, ' | 상세내역 : ', pca.CT_PRPOS, ' | 용도 : ', pca.ATDRN) AS PRJCT_DETAIL,
                CONCAT('상세내역 : ', pca.CT_PRPOS, ' | 용도 : ', pca.ATDRN) AS EMP_DETAIL,
                pca.UTZTN_AMT,
                CONCAT(SUBSTR(pca.UTZTN_DT, 1, 4),'-',SUBSTR(pca.UTZTN_DT, 5, 2),'-',SUBSTR(pca.UTZTN_DT, 7, 2)) AS UTZTN_DT
            FROM PRJCT_CT_APLY pca
            JOIN PRJCT_CT_ATRZ pah
                ON pca.PRJCT_ID = pah.PRJCT_ID
                AND pca.EMP_ID = pah.EMP_ID
                AND pca.APLY_YM = pah.APLY_YM
                AND pca.APLY_ODR = pah.APLY_ODR
                AND pah.ATRZ_DMND_STTS_CD = 'VTW03703' -- 결재요청상태코드 : 승인
            JOIN EMP e
                ON pca.EMP_ID = e.EMP_ID
            JOIN CD c
                ON pah.ATRZ_DMND_STTS_CD = c.CD_VALUE
            JOIN PRJCT p
                ON pca.PRJCT_ID = p.PRJCT_ID
            WHERE 1 = 1
            <if test="prjctId != null and !prjctId.equals('')">
                AND pca.PRJCT_ID = #{prjctId}
            </if>
            <if test="aplyYm != null and !aplyYm.equals('')">
                AND pca.APLY_YM = #{aplyYm}
            </if>
            <if test="aplyOdr != null and !aplyOdr.equals('')">
                AND pca.APLY_ODR = #{aplyOdr}
            </if>
            <if test="empNo != null and !empNo.equals('')">
                AND e.EMPNO = #{empNo}
            </if>
            <if test="expensCd != null and !expensCd.equals('')">
                AND pca.EXPENS_CD = #{expensCd}
            </if>
--         ) b
--         ON a.PIVOT_DATE = b.UTZTN_DT
--         ORDER BY PIVOT_DATE
    </select>

    <!--근무시간비용 입력현황 total조회-->
    <select id="retrieveTotWorkHrCtInptSttus" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            ALL_VTW,
            MM_03701,
            (ALL_VTW - MM_03701) AS MM_03701_MIN,
            MM_03702,
            (MM_03701 - MM_03702) AS MM_03702_MIN,
            MM_037034,
            (MM_03702 - MM_037034) AS MM_037034_MIN,
            CT_03701,
            (ALL_VTW - CT_03701) AS CT_03701_MIN,
            CT_03702,
            (CT_03701 - CT_03702) AS CT_03702_MIN,
            CT_037034,
            (CT_03702 - CT_037034) AS CT_037034_MIN,
            NULL AS EMP_ID
        FROM (
            SELECT COUNT(1) AS ALL_VTW
            FROM EMP e
            WHERE 1 = 1
            <if test="hdofSttsCd != null and !hdofSttsCd.equals('')">
                AND HDOF_STTS_CD = #{hdofSttsCd}
            </if>
            <if test="empId != null and !empId.equals('')">
                AND EMP_ID = #{empId}
            </if>
              AND EMP_TY_CD != 'VTW00203'
              AND e.EMPNO NOT IN ('VK0101', 'VK0102', 'VK0103', 'VK0104', 'VK0105', 'VK0106', 'VK0107', 'VK0108', 'VK0109', 'VK0110', 'VM1000')
        ) a, (
            SELECT
                COUNT(DISTINCT CASE WHEN pah.ATRZ_DMND_STTS_CD IN ('VTW03701','VTW03702','VTW03703','VTW03704') THEN pma.EMP_ID END) AS MM_03701,
                COUNT(DISTINCT CASE WHEN pah.ATRZ_DMND_STTS_CD IN ('VTW03702','VTW03703','VTW03704') THEN pma.EMP_ID END) AS MM_03702,
                COUNT(DISTINCT CASE WHEN pah.ATRZ_DMND_STTS_CD IN ('VTW03703','VTW03704') THEN pma.EMP_ID END) AS MM_037034
            FROM PRJCT_MM_APLY pma
            JOIN PRJCT_MM_ATRZ pah
                ON pma.PRJCT_ID = pah.PRJCT_ID
                AND pma.EMP_ID = pah.EMP_ID
                AND pma.APLY_YM = pah.APLY_YM
                AND pma.APLY_ODR = pah.APLY_ODR
--                 AND pah.PRJCT_ATRZ_HIST_SN = (
--                     SELECT MAX(PRJCT_ATRZ_HIST_SN)
--                     FROM PRJCT_ATRZ_HIST a
--                     WHERE a.PRJCT_ID = pah.PRJCT_ID
--                         AND a.EMP_ID = pah.EMP_ID
--                         AND a.APLY_YM = pah.APLY_YM
--                         AND a.APLY_ODR = pah.APLY_ODR
--             )
            WHERE 1 = 1
            <if test="aplyYm != null and !aplyYm.equals('')">
                AND pma.APLY_YM = #{aplyYm}
            </if>
            <if test="aplyOdr != null and !aplyOdr.equals('')">
                AND pma.APLY_ODR = #{aplyOdr}
            </if>
            <if test="hdofSttsCd != null and !hdofSttsCd.equals('')">
                AND pma.EMP_ID IN (SELECT EMP_ID FROM EMP WHERE HDOF_STTS_CD = #{hdofSttsCd})
            </if>
            <if test="empId != null and !empId.equals('')">
                AND pma.EMP_ID = #{empId}
            </if>
        ) b, (
            SELECT
                COUNT(DISTINCT CASE WHEN pah.ATRZ_DMND_STTS_CD IN ('VTW03701','VTW03702','VTW03703','VTW03704') THEN pca.EMP_ID END) AS CT_03701,
                COUNT(DISTINCT CASE WHEN pah.ATRZ_DMND_STTS_CD IN ('VTW03702','VTW03703','VTW03704') THEN pca.EMP_ID END) AS CT_03702,
                COUNT(DISTINCT CASE WHEN pah.ATRZ_DMND_STTS_CD IN ('VTW03703','VTW03704') THEN pca.EMP_ID END) AS CT_037034
            FROM PRJCT_CT_APLY pca
            JOIN PRJCT_CT_ATRZ pah
                ON pca.PRJCT_ID = pah.PRJCT_ID
                AND pca.EMP_ID = pah.EMP_ID
                AND pca.APLY_YM = pah.APLY_YM
                AND pca.APLY_ODR = pah.APLY_ODR
                <!--
                AND pah.PRJCT_CT_APLY_SN = (
                    SELECT MAX(PRJCT_CT_APLY_SN)
                    FROM PRJCT_CT_ATRZ a
                    WHERE a.PRJCT_ID = pah.PRJCT_ID
                        AND a.EMP_ID = pah.EMP_ID
                        AND a.APLY_YM = pah.APLY_YM
                        AND a.APLY_ODR = pah.APLY_ODR
            	)
            	-->
            	AND pca.PRJCT_CT_APLY_SN = pah.PRJCT_CT_APLY_SN
            WHERE 1 = 1
            <if test="aplyYm != null and !aplyYm.equals('')">
                AND pca.APLY_YM = #{aplyYm}
            </if>
            <if test="aplyOdr != null and !aplyOdr.equals('')">
                AND pca.APLY_ODR = #{aplyOdr}
            </if>
            <if test="hdofSttsCd != null and !hdofSttsCd.equals('')">
                AND pca.EMP_ID IN (SELECT EMP_ID FROM EMP WHERE HDOF_STTS_CD = #{hdofSttsCd})
            </if>
            <if test="empId != null and !empId.equals('')">
                AND pca.EMP_ID = #{empId}
            </if>
        ) c
    </select>

    <!--근무시간비용 입력현황 세부 조회-->
    <select id="retrieveWorkHrCtInptSttus" parameterType="map" resultType="com.trsystem.LowerHashMap">
	     SELECT
	     	    AA.EMPNO
	          , AA.EMP_ID
	          , AA.EMP_FLNM
	          , (SELECT CD_NM FROM CD WHERE CD_VALUE = AA.JBPS_CD) AS JBPS_NM
	          , AA.JBPS_CD
	          , (
	              SELECT DEPT_NM
	              FROM DEPT
	              WHERE DEPT_ID = (SELECT dh.DEPT_ID FROM DEPT_HNF dh WHERE dh.EMP_ID = AA.EMP_ID LIMIT 1)
	          ) AS DEPT_NM
	          , (
		         SELECT GROUP_CONCAT(DISTINCT DEPT_NM) DEPT_NM_ALL
		         FROM DEPT d
		         JOIN DEPT_HNF dh ON d.DEPT_ID = dh.DEPT_ID
		         JOIN EMP e ON dh.EMP_ID = e.EMP_ID 
		         WHERE e.EMP_ID = AA.EMP_ID
	          ) AS DEPT_NM_ALL
	          , AA.TELNO
	          , (SELECT CD_NM FROM CD WHERE CD_VALUE = AA.HDOF_STTS_CD) AS HDOF_STTS_NM
	          , IFNULL(BB.CT_CNT, 0) AS CT_CNT
	          , IFNULL(BB.PRJ_REJECT, 0) AS CT_REJECT
	          , IFNULL(BB.PRJ_COMPLETE, 0) AS CT_COMPLETE
	          , IFNULL(CC.MD_SUM,0) * 8 AS MD_SUM
	          , IFNULL(CC.VAC_SUM, 0) AS VAC_SUM
	          , IFNULL(CC.MM_COMPLETE, 0) AS MM_COMPLETE
	          , IFNULL(CC.MM_REJECT, 0) AS MM_REJECT
	          , CONCAT(CC.APLY_YM, '-', CC.APLY_ODR) AS TR_ODR
	          , CC.APLY_YM
	          , CC.APLY_ODR
	          , CC.MM_ATRZ_CMPTN_YN
	          , BB.CT_ATRZ_CMPTN_YN
	      FROM EMP AA
	      LEFT JOIN (
				  SELECT T1.EMP_ID
				       , T1.APLY_YM
				       , T1.APLY_ODR
				 	   , IFNULL(T1.CT_CNT, 0) AS CT_CNT
				   	   , IFNULL(T2.PRJ_COMPLETE, 0) AS PRJ_COMPLETE
				 	   , IFNULL(T3.PRJ_REJECT, 0) AS PRJ_REJECT
				 	   , T1.CT_ATRZ_CMPTN_YN
			  		FROM (
				  SELECT pca.EMP_ID
					   , pca.APLY_YM 
					   , pca.APLY_ODR 
					   , COUNT(1) CT_CNT
					   , picm.CT_ATRZ_CMPTN_YN
				    FROM PRJCT_CT_APLY pca
				    JOIN PRJCT_CT_ATRZ pcat ON (pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN AND pca.PRJCT_ID = pcat.PRJCT_ID AND pca.EMP_ID = pcat.EMP_ID AND pca.APLY_YM = pcat.APLY_YM)
				    JOIN PRJCT_INDVDL_CT_MM picm ON (pca.PRJCT_ID = picm.PRJCT_ID AND pca.EMP_ID = picm.EMP_ID AND pca.APLY_YM = picm.APLY_YM AND pca.APLY_ODR = picm.APLY_ODR)
				   WHERE 1=1
				     AND pca.APLY_YM = #{aplyYm}
				     AND pca.APLY_ODR = #{aplyOdr}
				  GROUP BY pca.EMP_ID, pca.APLY_YM, pca.APLY_ODR, picm.CT_ATRZ_CMPTN_YN
			  ) T1
		  LEFT JOIN (
				  SELECT pca.EMP_ID
					   , pca.APLY_YM 
					   , pca.APLY_ODR 
					   , COUNT(1) AS PRJ_COMPLETE
		 			   , picm.CT_ATRZ_CMPTN_YN
				    FROM PRJCT_CT_APLY pca
				    JOIN PRJCT_CT_ATRZ pcat ON (pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN AND pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN AND pca.PRJCT_ID = pcat.PRJCT_ID AND pca.EMP_ID = pcat.EMP_ID AND pca.APLY_YM = pcat.APLY_YM)
		  		    JOIN PRJCT_INDVDL_CT_MM picm ON (pca.PRJCT_ID = picm.PRJCT_ID AND pca.EMP_ID = picm.EMP_ID AND pca.APLY_YM = picm.APLY_YM AND pca.APLY_ODR = picm.APLY_ODR)
				   WHERE 1=1
				     AND pca.APLY_YM = #{aplyYm}
				     AND pca.APLY_ODR = #{aplyOdr}
				     AND pcat.ATRZ_DMND_STTS_CD = 'VTW03703'
				  GROUP BY pca.EMP_ID, pca.APLY_YM, pca.APLY_ODR, picm.CT_ATRZ_CMPTN_YN
			  ) T2 ON (T1.EMP_ID = T2.EMP_ID)
		  LEFT JOIN (
				  SELECT pca.EMP_ID
					   , pca.APLY_YM 
					   , pca.APLY_ODR 
					   , COUNT(1) AS PRJ_REJECT
		  			   , picm.CT_ATRZ_CMPTN_YN
				    FROM PRJCT_CT_APLY pca
				    JOIN PRJCT_CT_ATRZ pcat ON (pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN AND pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN AND pca.PRJCT_ID = pcat.PRJCT_ID AND pca.EMP_ID = pcat.EMP_ID AND pca.APLY_YM = pcat.APLY_YM)
				    JOIN PRJCT_INDVDL_CT_MM picm ON (pca.PRJCT_ID = picm.PRJCT_ID AND pca.EMP_ID = picm.EMP_ID AND pca.APLY_YM = picm.APLY_YM AND pca.APLY_ODR = picm.APLY_ODR)
				   WHERE 1=1
				     AND pca.APLY_YM = #{aplyYm}
				     AND pca.APLY_ODR = #{aplyOdr}
				     AND pcat.ATRZ_DMND_STTS_CD = 'VTW03704'
				  GROUP BY pca.EMP_ID, pca.APLY_YM, pca.APLY_ODR, picm.CT_ATRZ_CMPTN_YN
			  ) T3 ON (T2.EMP_ID = T3.EMP_ID)
	    ) BB ON BB.EMP_ID = AA.EMP_ID
	    LEFT OUTER JOIN (
	        SELECT T1.EMP_ID
	         	 , T1.APLY_YM
	         	 , T1.APLY_ODR
	         	 , IFNULL(SUM(T1.MM_CNT), 0) AS MD_SUM
	         	 , IFNULL(SUM(T2.MM_COMPLETE), 0) * 8 AS MM_COMPLETE
	         	 , IFNULL(SUM(T3.MM_REJECT), 0) * 8 AS MM_REJECT
	         	 , IFNULL(SUM(T2.VAC), 0) * 8 AS VAC_SUM
	         	 , T1.MM_ATRZ_CMPTN_YN
	        FROM (
				SELECT pca.EMP_ID
				     , pca.APLY_YM 
				     , pca.APLY_ODR 
				     , COUNT(1) MM_CNT
				     , pca.APLY_YMD
				     , 0 AS VAC
				     , picm.MM_ATRZ_CMPTN_YN
			      FROM PRJCT_MM_APLY pca
			      JOIN PRJCT_MM_ATRZ pcat ON (pcat.APLY_YMD = pca.APLY_YMD AND pca.PRJCT_ID = pcat.PRJCT_ID AND pca.EMP_ID = pcat.EMP_ID AND pca.APLY_YM = pcat.APLY_YM)
			      JOIN PRJCT_INDVDL_CT_MM picm ON (pca.PRJCT_ID = picm.PRJCT_ID AND pca.EMP_ID = picm.EMP_ID AND pca.APLY_YM = picm.APLY_YM AND pca.APLY_ODR = picm.APLY_ODR)
			     WHERE 1=1
			       AND pca.APLY_YM = #{aplyYm}
			       AND pca.APLY_ODR = #{aplyOdr}
			    GROUP BY pca.EMP_ID, pca.APLY_YM, pca.APLY_ODR, picm.MM_ATRZ_CMPTN_YN, pca.APLY_YMD
			    UNION
			  SELECT dv.ATRZ_DMND_EMP_ID
			       , dv.APLY_YM
			       , dv.APLY_ODR
			       , 0 AS MM_CNT
			       , dv.APLY_YMD
			       , 1 AS VAC
			  	   , picm.MM_ATRZ_CMPTN_YN
			    FROM (
					  WITH RECURSIVE DAILY_VACATION AS (SELECT
					          ELC.ELCTRN_ATRZ_ID ,
					          ELC.ATRZ_DMND_STTS_CD,
					          VAC.VCATN_TY_CD,
					          DATE(VAC.VCATN_BGNG_YMD) as dt,
					          DATE(VAC.VCATN_END_YMD) as end_dt,
					          ELC.ATRZ_DMND_EMP_ID,
					          ELC.PRJCT_ID
					     FROM ELCTRN_ATRZ ELC
					     JOIN VCATN_ATRZ VAC 
					       ON ELC.ELCTRN_ATRZ_ID = VAC.ELCTRN_ATRZ_ID
					    WHERE 1=1
					      AND ELC.ATRZ_DMND_STTS_CD = 'VTW03703'
					      AND VAC.VCATN_TY_CD != 'VTW01207'
					    UNION ALL
					   SELECT
					          dr.ELCTRN_ATRZ_ID ,
					          dr.ATRZ_DMND_STTS_CD,
					          dr.VCATN_TY_CD,
					          DATE_ADD(dr.dt, INTERVAL 1 DAY) as dt,
					          dr.end_dt,
					          dr.ATRZ_DMND_EMP_ID,
					          dr.PRJCT_ID
					    FROM DAILY_VACATION dr
					    <![CDATA[ 
					   WHERE dr.dt < dr.end_dt)
					    ]]>
					  SELECT ELCTRN_ATRZ_ID
						   , ATRZ_DMND_STTS_CD
						   , VCATN_TY_CD
						   , dt
						   , DATE_FORMAT(dt, '%Y%m%d') AS APLY_YMD
						   , SUBSTR(DATE_FORMAT(dt, '%Y%m%d'), 1, 6) AS APLY_YM
						   , CASE 
						 	 WHEN SUBSTR(DATE_FORMAT(dt, '%Y%m%d'), 7, 8) BETWEEN '01' AND '15' THEN '1'
						 	 ELSE '2'
						 END AS APLY_ODR
						   , ATRZ_DMND_EMP_ID
						   , PRJCT_ID
					   FROM DAILY_VACATION
				) dv
			 JOIN CRTR_DATE crd ON crd.CRTR_YMD = dv.APLY_YMD AND crd.HLDY_CL_CD = 'VTW05001'
			 JOIN PRJCT_INDVDL_CT_MM picm 
			   ON (
				   picm.PRJCT_ID = dv.PRJCT_ID 
				   AND picm.APLY_YM = dv.APLY_YM
				   AND picm.APLY_ODR = dv.APLY_ODR
				   AND picm.EMP_ID = dv.ATRZ_DMND_EMP_ID
				)
			WHERE 1=1
			  AND dv.APLY_YM = #{aplyYm}
			  AND dv.APLY_ODR = #{aplyOdr}
			  AND dv.ATRZ_DMND_STTS_CD = 'VTW03703'
	        ) T1 
	        LEFT JOIN (
			  SELECT pca.EMP_ID
				   , pca.APLY_YM 
				   , pca.APLY_ODR 
				   , COUNT(1) AS MM_COMPLETE
				   , pca.APLY_YMD
				   , 0 AS VAC
				   , picm.MM_ATRZ_CMPTN_YN
			    FROM PRJCT_MM_APLY pca
			    JOIN PRJCT_MM_ATRZ pcat ON (pcat.APLY_YMD = pca.APLY_YMD AND pca.PRJCT_ID = pcat.PRJCT_ID AND pca.EMP_ID = pcat.EMP_ID AND pca.APLY_YM = pcat.APLY_YM)
			    JOIN PRJCT_INDVDL_CT_MM picm ON (pca.PRJCT_ID = picm.PRJCT_ID AND pca.EMP_ID = picm.EMP_ID AND pca.APLY_YM = picm.APLY_YM AND pca.APLY_ODR = picm.APLY_ODR)
			   WHERE 1=1
			     AND pca.APLY_YM = #{aplyYm}
			     AND pca.APLY_ODR = #{aplyOdr}
			     AND pcat.ATRZ_DMND_STTS_CD = 'VTW03703'
			  GROUP BY pca.EMP_ID, pca.APLY_YM, pca.APLY_ODR, picm.MM_ATRZ_CMPTN_YN, pca.APLY_YMD
			  UNION
			  SELECT dv.ATRZ_DMND_EMP_ID
			       , dv.APLY_YM
			       , dv.APLY_ODR
			       , 0 AS MM_COMPLETE
			       , dv.APLY_YMD
			       , 1 AS VAC
			  	   , picm.MM_ATRZ_CMPTN_YN
			    FROM (
					  WITH RECURSIVE DAILY_VACATION AS (SELECT
					          ELC.ELCTRN_ATRZ_ID ,
					          ELC.ATRZ_DMND_STTS_CD,
					          VAC.VCATN_TY_CD,
					          DATE(VAC.VCATN_BGNG_YMD) as dt,
					          DATE(VAC.VCATN_END_YMD) as end_dt,
					          ELC.ATRZ_DMND_EMP_ID,
					          ELC.PRJCT_ID
					     FROM ELCTRN_ATRZ ELC
					     JOIN VCATN_ATRZ VAC 
					       ON ELC.ELCTRN_ATRZ_ID = VAC.ELCTRN_ATRZ_ID
					    WHERE 1=1
					      AND ELC.ATRZ_DMND_STTS_CD = 'VTW03703'
					      AND VAC.VCATN_TY_CD != 'VTW01207'
					    UNION ALL
					   SELECT
					          dr.ELCTRN_ATRZ_ID ,
					          dr.ATRZ_DMND_STTS_CD,
					          dr.VCATN_TY_CD,
					          DATE_ADD(dr.dt, INTERVAL 1 DAY) as dt,
					          dr.end_dt,
					          dr.ATRZ_DMND_EMP_ID,
					          dr.PRJCT_ID
					    FROM DAILY_VACATION dr
					    <![CDATA[ 
					   WHERE dr.dt < dr.end_dt)
					    ]]>
					  SELECT ELCTRN_ATRZ_ID
						   , ATRZ_DMND_STTS_CD
						   , VCATN_TY_CD
						   , dt
						   , DATE_FORMAT(dt, '%Y%m%d') AS APLY_YMD
						   , SUBSTR(DATE_FORMAT(dt, '%Y%m%d'), 1, 6) AS APLY_YM
						   , CASE 
						 	 WHEN SUBSTR(DATE_FORMAT(dt, '%Y%m%d'), 7, 8) BETWEEN '01' AND '15' THEN '1'
						 	 ELSE '2'
						 END AS APLY_ODR
						   , ATRZ_DMND_EMP_ID
						   , PRJCT_ID
					   FROM DAILY_VACATION
				) dv
			 JOIN CRTR_DATE crd ON crd.CRTR_YMD = dv.APLY_YMD AND crd.HLDY_CL_CD = 'VTW05001'
			 JOIN PRJCT_INDVDL_CT_MM picm 
			   ON (
				   picm.PRJCT_ID = dv.PRJCT_ID 
				   AND picm.APLY_YM = dv.APLY_YM
				   AND picm.APLY_ODR = dv.APLY_ODR
				   AND picm.EMP_ID = dv.ATRZ_DMND_EMP_ID
				)
			WHERE 1=1
			  AND dv.APLY_YM = #{aplyYm}
			  AND dv.APLY_ODR = #{aplyOdr}
			  AND dv.ATRZ_DMND_STTS_CD = 'VTW03703'
	        ) T2 ON (T1.EMP_ID = T2.EMP_ID AND T1.APLY_YMD = T2.APLY_YMD)
	        LEFT JOIN (
	 			  SELECT pca.EMP_ID
					   , pca.APLY_YM 
					   , pca.APLY_ODR 
					   , COUNT(1) AS MM_REJECT
					   , pca.APLY_YMD
	   			       , 0 AS VAC
		 			   , picm.MM_ATRZ_CMPTN_YN
				    FROM PRJCT_MM_APLY pca
				    JOIN PRJCT_MM_ATRZ pcat ON (pcat.APLY_YMD = pca.APLY_YMD AND pca.PRJCT_ID = pcat.PRJCT_ID AND pca.EMP_ID = pcat.EMP_ID AND pca.APLY_YM = pcat.APLY_YM)
		  		    JOIN PRJCT_INDVDL_CT_MM picm ON (pca.PRJCT_ID = picm.PRJCT_ID AND pca.EMP_ID = picm.EMP_ID AND pca.APLY_YM = picm.APLY_YM AND pca.APLY_ODR = picm.APLY_ODR)
				   WHERE 1=1
				     AND pca.APLY_YM = #{aplyYm}
				     AND pca.APLY_ODR = #{aplyOdr}
				     AND pcat.ATRZ_DMND_STTS_CD = 'VTW03704'
				  GROUP BY pca.EMP_ID, pca.APLY_YM, pca.APLY_ODR, picm.MM_ATRZ_CMPTN_YN, pca.APLY_YMD      
	        ) T3 ON (T1.EMP_ID = T3.EMP_ID AND T1.APLY_YMD = T3.APLY_YMD)
	        GROUP BY T1.EMP_ID, T1.APLY_YM, T1.APLY_ODR, T1.MM_ATRZ_CMPTN_YN
	    ) CC
	        ON CC.EMP_ID = AA.EMP_ID
	    WHERE 1 = 1
          AND AA.EMP_TY_CD != 'VTW00203'
        <if test="hdofSttsCd != null and !hdofSttsCd.equals('')">
            AND AA.HDOF_STTS_CD = #{hdofSttsCd}
        </if>
          AND AA.EMPNO NOT IN ('VK0101', 'VK0102', 'VK0103', 'VK0104', 'VK0105', 'VK0106', 'VK0107', 'VK0108', 'VK0109', 'VK0110', 'VM1000')
        <if test="empId != null and empId !=''">
            AND AA.EMP_ID = #{empId}
        </if>
		<if test="allVtw != true">
	        <choose>
				<when test="mm03701 == true and mm03701Min == true">
				  AND (MD_SUM > 0 OR IFNULL(MD_SUM, 0) = 0)
				</when>
				<when test="mm03701 == true">
				  AND MD_SUM > 0
				</when>
				<when test="mm03701Min == true">
				  AND IFNULL(MD_SUM, 0) = 0
				</when>
			</choose>
	        <choose>
				<when test="ct03701 == true and ct03701Min == true">
				  AND (CT_CNT > 0 OR IFNULL(CT_CNT, 0) = 0)
				</when>
				<when test="ct03701 == true">
				  AND CT_CNT > 0
				</when>
				<when test="ct03701Min == true">
				  AND IFNULL(CT_CNT, 0) = 0
				</when>
			</choose>
	        <choose>
				<when test="mm03702 == true and mm03702Min == true">
				<![CDATA[
				  AND ((CC.MM_ATRZ_CMPTN_YN IS NULL AND BB.CT_CNT > 0) OR CC.MM_ATRZ_CMPTN_YN IS NOT NULL)
	  			]]>
				</when>
				<when test="mm03702 == true">
				  AND CC.MM_ATRZ_CMPTN_YN IS NOT NULL
				</when>
				<when test="mm03702Min == true">
				<![CDATA[
				  AND (CC.MM_ATRZ_CMPTN_YN IS NULL AND BB.CT_CNT > 0)
	  			]]>
				</when>
			</choose>
	        <choose>
				<when test="ct03702 == true and ct03702Min == true">
				<![CDATA[
				  AND ((BB.CT_ATRZ_CMPTN_YN IS NULL AND BB.CT_CNT > 0) OR BB.CT_ATRZ_CMPTN_YN IS NOT NULL)
	  			]]>
				</when>
				<when test="ct03702 == true">
				  AND BB.CT_ATRZ_CMPTN_YN IS NOT NULL 
				</when>
				<when test="ct03702Min == true">
				<![CDATA[
				  AND (BB.CT_ATRZ_CMPTN_YN IS NULL AND BB.CT_CNT > 0)
				]]>
				</when>
			</choose>
	        <choose>
				<when test="mm037034 == true and mm037034Min == true">
				<![CDATA[ 
				  AND (CC.MM_REJECT > 0 OR CC.MM_COMPLETE > 0 OR CC.MM_REJECT <= 0 OR CC.MM_COMPLETE <= 0)
				]]>
				</when>
				<when test="mm037034 == true">
				<![CDATA[ 
				  AND (CC.MM_REJECT > 0 OR CC.MM_COMPLETE > 0)
	  			]]>
				</when>
				<when test="mm037034Min == true">
				<![CDATA[ 
				  AND (CC.MM_REJECT <= 0 AND CC.MM_COMPLETE <=0)
	  			]]>
				</when>
			</choose>
	        <choose>
				<when test="ct037034 == true and ct037034Min == true">
				<![CDATA[ 
				  AND (BB.CT_REJECT > 0 OR BB.CT_COMPLETE > 0 OR BB.CT_REJECT <= 0 OR BB.CT_COMPLETE <= 0)
				]]>
				</when>
				<when test="ct037034 == true">
				<![CDATA[ 
				  AND (BB.CT_REJECT > 0 OR BB.CT_COMPLETE > 0)
	  			]]>
				</when>
				<when test="ct037034Min == true">
				<![CDATA[ 
				  AND (BB.CT_REJECT <= 0 AND BB.CT_COMPLETE <=0)
	  			]]>
				</when>
			</choose>			
		</if>
		ORDER BY AA.EMPNO
    </select>

    <!--/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->
    <!--/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->
    <!--/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->


    <!--근무시간 승인 내역 -->
    <select id="retrievePrjctMmAplyList" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
        P.PRJCT_ID AS PRJCT_ID,
        DATE_FORMAT(PMA.APLY_YMD , '%Y-%m-%d') AS APLY_YMD,
        P.PRJCT_NM AS PRJCT_NM,
        E.EMP_FLNM AS EMP_FLNM,
        CASE
        WHEN PMA.MD = 1 THEN 8
        WHEN PMA.MD = 0.5 THEN 4
        ELSE 0
        END AS MD
        FROM PRJCT_MM_APLY PMA, PRJCT P , PRJCT_INDVDL_CT_MM PICM, EMP E
        WHERE 1=1
        AND PMA.PRJCT_ID = PICM.PRJCT_ID
        AND   PMA.EMP_ID = PICM.EMP_ID
        AND   PMA.APLY_YM = PICM.APLY_YM
        AND   PMA.APLY_ODR = PICM.APLY_ODR
        AND   P.PRJCT_ID  = PMA.PRJCT_ID
        AND   PMA.EMP_ID  = E.EMP_ID
        AND PICM.MM_ATRZ_CMPTN_YN = 'Y'
        <if test="yearItem != null and yearItem !=''">
            AND DATE_FORMAT(PMA.APLY_YMD , '%Y') = #{yearItem}
        </if>

        <if test="monthItem != null and monthItem !=''">
            AND DATE_FORMAT(PMA.APLY_YMD , '%m') = #{monthItem}
        </if>

        <if test="aplyOdr != null and aplyOdr !=''">
            AND PMA.APLY_ODR = #{aplyOdr}
        </if>

        <if test="prjctId != null and prjctId !=''">
            AND PMA.PRJCT_ID = #{prjctId}
        </if>

    </select>


    <!--근무시간, 경비 통합승인 내역 -->
    <select id="retrieveWorkHrAprvList" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            W_EMP_ID  AS EMP_ID,
            EMP_FLNM ,
            PRJCT_NM,
            FORMAT(PRJCT_NON_INSERT, 1) AS PRJCT_NON_INSERT,
            FORMAT(PRJCT_INSERT, 1) AS PRJCT_INSERT,
            FORMAT(VACATION, 1) AS VACATION,
            FORMAT(TOTAL_PRJCT_NON_INSERT, 1) AS TOTAL_PRJCT_NON_INSERT,
            FORMAT(TOTAL_PRJCT_INSERT, 1) AS TOTAL_PRJCT_INSERT,
            PRJCT_NON_INSERT_EXPENSE,
            PRJCT_INSERT_EXPENSE AS PRJCT_INSERT_EXPENSE
        FROM
            (
                SELECT
                    E.EMP_ID AS W_EMP_ID,
                    E.EMP_FLNM AS EMP_FLNM,
                    P.PRJCT_NM AS PRJCT_NM ,
                    P.PRJCT_ID AS W_PRJCT_ID,
                    E.EMPNO AS W_EMPNO,
                    E.EMP_TY_CD AS W_EMP_TY_CD,
                    SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01801' THEN
                                 CASE WHEN PMA.MD = 0 THEN 0
                                      WHEN PMA.MD = 0.5 THEN 4
                                      WHEN PMA.MD = 1 THEN 8
                                      ELSE 0 END
                             ELSE 0 END) AS PRJCT_NON_INSERT,
                    SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01802' THEN
                                 CASE WHEN PMA.MD = 0 THEN 0
                                      WHEN PMA.MD = 0.5 THEN 4
                                      WHEN PMA.MD = 1 THEN 8
                                      ELSE 0 END
                             ELSE 0 END) AS PRJCT_INSERT,
                    SUM(CASE WHEN PMA.YRYC_RATE = 0 THEN 0
                             WHEN PMA.YRYC_RATE = 0.5 THEN 4
                             WHEN PMA.YRYC_RATE = 1 THEN 8
                             ELSE 0 END) AS VACATION ,
                    (SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01801' THEN
                                  CASE WHEN PMA.MD = 0 THEN 0
                                       WHEN PMA.MD = 0.5 THEN 4
                                       WHEN PMA.MD = 1 THEN 8
                                       ELSE 0 END
                              ELSE 0 END) +
                     SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01801' THEN
                                  CASE WHEN PMA.YRYC_RATE = 0 THEN 0
                                       WHEN PMA.YRYC_RATE = 0.5 THEN 4
                                       WHEN PMA.YRYC_RATE = 1 THEN 8
                                       ELSE 0 END
                              ELSE 0 END)
                        ) AS TOTAL_PRJCT_NON_INSERT,
                    (SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01802' THEN
                                  CASE WHEN PMA.MD = 0 THEN 0
                                       WHEN PMA.MD = 0.5 THEN 4
                                       WHEN PMA.MD = 1 THEN 8
                                       ELSE 0 END
                              ELSE 0 END) +
                     SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01802' THEN
                                  CASE WHEN PMA.YRYC_RATE = 0 THEN 0
                                       WHEN PMA.YRYC_RATE = 0.5 THEN 4
                                       WHEN PMA.YRYC_RATE = 1 THEN 8
                                       ELSE 0 END
                              ELSE 0 END)
                        ) AS TOTAL_PRJCT_INSERT
                FROM
                    PRJCT_INDVDL_CT_MM PICM ,
                    PRJCT_MM_APLY PMA,
                    PRJCT P,
                    EMP E
                WHERE
                    PICM.PRJCT_ID = PMA.PRJCT_ID
                  AND PICM.EMP_ID = PMA.EMP_ID
                  AND PICM.APLY_YM = PMA.APLY_YM
                  AND PICM.APLY_ODR = PMA.APLY_ODR
                  AND P.PRJCT_ID = PICM.PRJCT_ID
                  AND PMA.EMP_ID = E.EMP_ID
                  AND PICM.MM_ATRZ_CMPTN_YN = 'Y'
                GROUP BY
                    E.EMP_ID,
                    E.EMP_FLNM ,
                    P.PRJCT_NM ,
                    P.PRJCT_ID,
                    PMA.YRYC_RATE
            ) WORK_HOUR,
            (
                SELECT
                    E.EMP_ID AS C_EMP_ID,
                    P.PRJCT_ID AS C_PRJCT_ID,
                    P.PRJCT_NM AS C_PRJCT_NM,
                    SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01801' THEN PCA.UTZTN_AMT ELSE 0 END ) PRJCT_NON_INSERT_EXPENSE
                        ,
                    SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01802' THEN PCA.UTZTN_AMT ELSE 0 END ) PRJCT_INSERT_EXPENSE
                FROM
                    PRJCT_INDVDL_CT_MM PICM ,
                    PRJCT P,
                    EMP E,
                    PRJCT_CT_APLY PCA
                WHERE
                    1 = 1
                  AND E.EMP_ID = PICM.EMP_ID
                  AND PICM.PRJCT_ID = P.PRJCT_ID
                  AND PICM.PRJCT_ID = PCA.PRJCT_ID
                  AND PICM.EMP_ID = PCA.EMP_ID
                  AND PICM.APLY_YM = PCA.APLY_YM
                  AND PICM.APLY_ODR = PCA.APLY_ODR
                  AND PICM.CT_ATRZ_CMPTN_YN = 'Y'
                GROUP BY
                    E.EMP_ID,
                    E.EMP_FLNM ,
                    P.PRJCT_NM,
                    P.PRJCT_ID) CT_LIST
        WHERE WORK_HOUR.W_PRJCT_ID = CT_LIST.C_PRJCT_ID
          AND   WORK_HOUR.W_EMP_ID = CT_LIST.C_EMP_ID
        <if test="prjctId != null and prjctId !=''">
            AND   W_PRJCT_ID = #{prjctId}
        </if>
        <if test="empFlnm != null and empFlnm !=''">
            AND   EMP_FLNM LIKE CONCAT('%', #{empFlnm}, '%')
        </if>
        <if test="empno != null and empno !=''">
            AND   W_EMPNO LIKE CONCAT('%', #{empno}, '%')
        </if>
        <if test="hdofSttsNm != null and hdofSttsNm !=''">
            AND   W_EMP_TY_CD LIKE CONCAT('%', #{hdofSttsNm}, '%')
        </if>





    </select>

    <!-- 문체비 마감 내역 -->
    <select id="retrieveClturPhstrnDdlnList" parameterType="map" resultType="com.trsystem.LowerHashMap">

        SELECT
            E.EMP_ID AS EMP_ID
            ,C.CD_NM   AS BANK_NAME
             ,E.ACTNO  AS ACTNO
             ,E.EMP_FLNM AS EMP_FLNM
             ,CPAC.DPST_AMT  AS DPST_AMT
             ,CONCAT(SUBSTR(CLTUR_PHSTRN_ACT_MNG_YM,5), '월 문화체련비' ) AS REMARK
        FROM CLTUR_PHSTRN_ACT_CT CPAC
                 JOIN EMP E ON E.EMP_ID = CPAC.EMP_ID
                 JOIN CD  C ON C.CD_VALUE  = E.BANK_CD

    </select>

    <select id="retrieveClturPhstrnIndvdlList" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
             E.EMP_ID AS EMP_ID
             ,E.EMP_FLNM AS EMP_FLNM
             ,CPAC.CLTUR_PHSTRN_ACT_MNG_YM AS CLM_YM
             ,CPAC.CLM_AMT AS CLM_AMT
             ,CPAC.DPST_AMT AS DPST_AMT
             ,CPAC.CYFD_AMT + CPAC.CLM_AMT - CPAC.DPST_AMT AS BALANCE
        FROM CLTUR_PHSTRN_ACT_CT CPAC
                 JOIN EMP E ON E.EMP_ID = CPAC.EMP_ID
        <if test="empId != null and empId !=''">
            WHERE   E.EMPNO = #{empId}
        </if>
    </select>

    <!-- 문체비 관리 목록 -->
    <select id="retrieveClturPhstrnCtClmList" parameterType="map" resultType="com.trsystem.LowerHashMap">
       SELECT
            C.EMP_ID,
            C.EMP_FLNM,
            C.YM,
            C.EXPENSE_TYPE,
            C.CYFD_AMT,
            C.CLM_AMT,
            C.DPST_AMT,
            C.BALANCE,
            C.DPST_YMD
       FROM (
            SELECT
                e.EMP_ID,
                e.JBPS_CD,
                CONCAT('(', e.EMPNO, ')', ' ', e.EMP_FLNM) AS EMP_FLNM,
                e.YM AS YM,
                '문화비' AS EXPENSE_TYPE,
                IFNULL(cpac.CLTUR_CT_CYFD_AMT, 0) AS CYFD_AMT,
                IFNULL(cpac.CLTUR_CT_CLM_AMT, 0) AS CLM_AMT,
                IFNULL(cpac.CLTUR_CT_DPST_AMT, 0) AS DPST_AMT,
                IFNULL(cpac.CLTUR_CT_CYFD_AMT, 0) + IFNULL(cpac.CLTUR_CT_CLM_AMT, 0) - IFNULL(cpac.CLTUR_CT_DPST_AMT, 0) AS BALANCE,
                cpac.CLTUR_CT_DPST_YMD AS DPST_YMD
            FROM (
                SELECT
                    e.EMP_ID,
                    e.EMP_FLNM,
                    e.EMPNO,
                    e.JBPS_CD,
                    #{clturPhstrnActMngYm} AS YM
                FROM EMP e
                WHERE 1=1
                  AND (#{empFlnm} IS NULL OR e.EMP_FLNM LIKE CONCAT('%', #{empFlnm}, '%'))
                  AND (#{empno} IS NULL OR e.EMPNO LIKE CONCAT('%', #{empno}, '%'))
            ) e
            LEFT JOIN CLTUR_PHSTRN_ACT_CT cpac ON cpac.EMP_ID = e.EMP_ID AND cpac.CLTUR_PHSTRN_ACT_MNG_YM = e.YM
            GROUP BY EMP_ID, EMPNO, EMP_FLNM, YM
            UNION ALL
            SELECT
                e.EMP_ID,
                e.JBPS_CD,
                CONCAT('(', e.EMPNO, ')', ' ', e.EMP_FLNM) AS EMP_FLNM,
                e.YM AS YM,
                '체력단련비' AS EXPENSE_TYPE,
                IFNULL(cpac.FTNESS_TRNG_CT_CYFD_AMT, 0) AS CYFD_AMT,
                IFNULL(cpac.FTNESS_TRNG_CT_CLM_AMT, 0) AS CLM_AMT,
                IFNULL(cpac.FTNESS_TRNG_CT_DPST_AMT, 0) AS DPST_AMT,
                IFNULL(cpac.FTNESS_TRNG_CT_CYFD_AMT, 0) + IFNULL(cpac.FTNESS_TRNG_CT_CLM_AMT, 0) - IFNULL(cpac.FTNESS_TRNG_CT_DPST_AMT, 0) AS BALANCE,
                cpac.FTNESS_TRNG_CT_DPST_YMD AS DPST_YMD
            FROM (
                 SELECT
                     e.EMP_ID,
                     e.EMP_FLNM,
                     e.EMPNO,
                     e.JBPS_CD,
                     #{clturPhstrnActMngYm} AS YM
                 FROM EMP e
                 WHERE 1=1
                   AND (#{empFlnm} IS NULL OR e.EMP_FLNM LIKE CONCAT('%', #{empFlnm}, '%'))
                   AND (#{empno} IS NULL OR e.EMPNO LIKE CONCAT('%', #{empno}, '%'))
            ) e
            LEFT JOIN CLTUR_PHSTRN_ACT_CT cpac ON cpac.EMP_ID = e.EMP_ID AND cpac.CLTUR_PHSTRN_ACT_MNG_YM = e.YM
            GROUP BY EMP_ID, EMPNO, EMP_FLNM, YM
       ) C
       ORDER BY JBPS_CD, EXPENSE_TYPE
    </select>
    
    <select id="retrieveCtData" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT pca.PRJCT_CT_APLY_SN 
		  FROM PRJCT_CT_APLY pca
		  JOIN PRJCT_CT_ATRZ pcat ON (pca.PRJCT_CT_APLY_SN = pcat.PRJCT_CT_APLY_SN)
		 WHERE 1=1
	      AND (pca.CT_ATRZ_SE_CD = 'VTW01902' OR pca.CT_ATRZ_SE_CD = 'VTW01903')
		   AND pca.EMP_ID = #{empId}
		   AND pca.APLY_YM = #{aplyYm}
		   AND pca.APLY_ODR = #{aplyOdr}
		   AND pcat.ATRZ_DMND_STTS_CD = 'VTW03703'
	</select>
    
    <select id="retrieveCtPivotData" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT CONCAT(p.PRJCT_NM, '(', p.PRJCT_CD_IDNTFR , ')') PRJCT_NM_CD
			 , c1.CD_NM AS CT_ATRZ_SE_CD_NM
			 , c2.CD_NM AS EXPENS_CD_NM
			 , CONCAT(IFNULL(SUBSTRING(cd.CRTR_YMD, 7, 8), SUBSTRING(LEFT(pca.UTZTN_DT, 8), 7, 8)), pca.CT_PRPOS) AS CT_PRPOS
			 , pca.ATDRN
			 , pca.UTZTN_AMT
			 , IFNULL(SUBSTRING(cd.CRTR_YMD, 7, 8), '기타') AS DAY
		  FROM PRJCT_CT_APLY pca
		  JOIN PRJCT_INDVDL_CT_MM picm ON (pca.EMP_ID = picm.EMP_ID AND pca.APLY_YM = picm.APLY_YM AND pca.APLY_ODR = picm.APLY_ODR)
		  JOIN PRJCT p ON (picm.PRJCT_ID = p.PRJCT_ID)
		  JOIN CD c1 ON (c1.CD_VALUE = pca.CT_ATRZ_SE_CD)
		  JOIN CD c2 ON (c2.CD_VALUE = pca.EXPENS_CD)
		  LEFT JOIN CRTR_DATE cd ON (cd.CRTR_YMD LIKE CONCAT(pca.APLY_YM, '%') AND cd.CRTR_ODR = pca.APLY_ODR AND LEFT(pca.UTZTN_DT, 8) = cd.CRTR_YMD)
  		  JOIN PRJCT_CT_ATRZ pcat ON (pca.PRJCT_CT_APLY_SN = pcat.PRJCT_CT_APLY_SN)
		 WHERE 1=1
		   AND pca.EMP_ID = #{empId}
		   AND pca.APLY_YM = #{aplyYm}
		   AND pca.APLY_ODR = #{aplyOdr}
		   AND (pca.CT_ATRZ_SE_CD = 'VTW01902' OR pca.CT_ATRZ_SE_CD = 'VTW01903')	-- 현금/개인법인카드
		AND pcat.ATRZ_DMND_STTS_CD = 'VTW03703' 
		UNION
		SELECT CONCAT(p.PRJCT_NM, '(', p.PRJCT_CD_IDNTFR , ')') PRJCT_NM_CD
			 , c1.CD_NM AS CT_ATRZ_SE_CD_NM
			 , c2.CD_NM AS EXPENS_CD_NM
			 , CONCAT(SUBSTRING(LEFT(pca.UTZTN_DT, 8), 7, 8), pca.CT_PRPOS) AS CT_PRPOS
			 , pca.ATDRN
			 , CASE WHEN SUBSTRING(LEFT(pca.UTZTN_DT, 8), 7, 8) = SUBSTRING(cd.CRTR_YMD, 7, 8) THEN pca.UTZTN_AMT
			   ELSE NULL
			   END AS UTZTN_AMT
		 	 , IFNULL(SUBSTRING(cd.CRTR_YMD, 7, 8), SUBSTRING(LEFT(pca.UTZTN_DT, 8), 7, 8)) AS DAY
		  FROM CRTR_DATE cd
		  JOIN PRJCT_CT_APLY pca
		  JOIN PRJCT p ON p.PRJCT_ID = pca.PRJCT_ID
		  JOIN CD c1 ON (c1.CD_VALUE = pca.CT_ATRZ_SE_CD)
		  JOIN CD c2 ON (c2.CD_VALUE = pca.EXPENS_CD)
		 WHERE 1=1
		   AND cd.CRTR_YMD LIKE CONCAT(#{aplyYm},'%')
		   AND cd.CRTR_ODR = #{aplyOdr}
		   AND pca.PRJCT_CT_APLY_SN = #{prjctCtAplySn}
   		   AND pca.EMP_ID = #{empId}
		   AND pca.APLY_YM = #{aplyYm}
		   AND pca.APLY_ODR = #{aplyOdr}
		   AND pca.PRJCT_ID = #{prjctId}
	</select>

    <select id="getWorkDay" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT CRTR_YMD 
		  FROM CRTR_DATE cd
		 WHERE 1=1
		   AND CRTR_YMD LIKE CONCAT(#{aplyYm}, '%') 
		   AND CRTR_ODR = #{aplyOdr}
	</select>
	
    <select id="retrieveDdlYn" parameterType="map" resultType="com.trsystem.LowerHashMap">
		  SELECT DISTINCT (DDLN_YN) AS DDLN_YN
		  FROM CRTR_DATE cd
		 WHERE 1=1
		   AND SUBSTR(CRTR_YMD, 1, 6) = #{aplyYm}
		   AND CRTR_ODR = #{aplyOdr}
	</select>
	
    <select id="retrieveClosingList" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT cd.CD_NM AS BANK_CD_NM
			 , e.ACTNO
			 , SUM(pca.UTZTN_AMT) AS SUM_UTZTN_AMT
			 , e.EMP_FLNM
			 , CONCAT(pca.APLY_YM, '-', pca.APLY_ODR, ' TR') AS TR
		  FROM EMP e
		  JOIN PRJCT_CT_APLY pca 
		    ON (pca.EMP_ID = e.EMP_ID)
		  JOIN PRJCT_CT_ATRZ pcat
		    ON (
		    	pca.EMP_ID = pcat.EMP_ID 
		    AND pca.PRJCT_ID = pcat.PRJCT_ID 
		    AND pca.APLY_YM = pcat.APLY_YM 
		    AND pca.APLY_ODR = pcat.APLY_ODR 
		    AND pca.PRJCT_CT_APLY_SN = pcat.PRJCT_CT_APLY_SN
		    )
		  LEFT JOIN CD cd
		    ON (cd.CD_VALUE = e.BANK_CD)
		 WHERE pca.APLY_YM = #{aplyYm}
		   AND pca.APLY_ODR = #{aplyOdr}
		   AND pcat.ATRZ_DMND_STTS_CD = 'VTW03703'
		GROUP BY BANK_CD_NM, e.ACTNO, e.EMP_FLNM
	</select>
	
</mapper>